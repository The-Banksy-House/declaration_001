<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>i_am_dave — Mint (Base Sepolia)</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box}
  :root{--bg:#2B2B2B;--fg:#F3F3F3;--panel:#1f1f1f;--border:#3a3a3a;--accent:#7bd389}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:"JetBrains Mono",monospace}
  .wrap{max-width:560px;margin:0 auto;padding:max(24px, env(safe-area-inset-top)) 24px 24px}
  h1{font-size:18px;margin:0 0 6px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
  .btn{display:block;width:100%;background:#0c0c0c;border:1px solid var(--border);color:var(--fg);border-radius:10px;padding:12px 16px;font-size:16px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.small{width:auto;padding:8px 12px;font-size:12px}
  .input{width:100%;background:#151515;border:1px solid var(--border);color:var(--fg);border-radius:10px;padding:12px 14px;font-family:inherit;font-size:16px}
  .hint{font-size:12px;opacity:.85}
  .nft{width:100%;aspect-ratio:1/1;background:#2B2B2B;border:1px solid var(--border);border-radius:12px;display:grid;place-items:center;overflow:hidden}
  .nft img{max-width:90%;max-height:90%;display:block}
  .row{display:flex;align-items:center;gap:8px}
  .grow{flex:1}
  .right{text-align:right;margin-top:6px;opacity:.85;font-size:12px}
  .badge{display:inline-block;border:1px solid var(--border);border-radius:8px;padding:2px 6px;font-size:11px;opacity:.95}
  a.link{color:var(--fg);text-decoration:underline}
  .banner{background:#3a2b2b;border:1px solid #6b3a3a;color:#f3e6e6;padding:10px 12px;border-radius:8px;display:none;margin-bottom:8px}

  /* Wallet chooser (accessible modal) */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{width:min(480px,92vw);background:#121212;border:1px solid var(--border);border-radius:14px;padding:16px}
  .modal h2{margin:0 0 8px;font-size:16px}
  .prov{display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#1a1a1a;color:var(--fg);cursor:pointer}
  .prov:hover{border-color:#555}
  .prov:focus{outline:2px solid var(--accent);outline-offset:2px}
  .prov img{width:22px;height:22px;border-radius:6px}
  .provname{font-size:14px}
  .provsub{margin-top:2px;font-size:11px;opacity:.8}
  .chooserGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
  .footrow{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  .linklike{background:none;border:none;color:var(--accent);cursor:pointer;font-size:12px;text-decoration:underline;padding:0}
</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
/* =================== CONFIG =================== */
const CHAIN_ID_HEX = "0x14a34"; // 84532
const EXPLORER = "https://sepolia.basescan.org";
const DECLARATION_ADDR = "0xB0731E7ea189c169640Fd890E5dcE9811040D0eA";
const SBT_ADDR         = "0xe255130A9e2277640d3DfB045075a38d63a34D06";
const DECLARATION_DEPLOY_BLOCK = 30558001;

const BASE_SEPOLIA = {
  chainId: CHAIN_ID_HEX,
  chainName: "Base Sepolia",
  nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
  rpcUrls: ["https://sepolia.base.org"],
  blockExplorerUrls: [EXPLORER]
};

/* ABIs */
const DECLARATION_ABI = [
  "function hasSigned(address) view returns (bool)",
  "function signatureByAddress(address) view returns (string)",
  "function cosignDeclaration(string chosenName)",
  "event DeclarationSigned(address indexed signatory, string daveName, uint256 signatureNumber, uint256 blockNumber)"
];
const SBT_ABI = [
  "function claimWithSignee(uint256 signeeNumber)",
  "function tokenIdOf(address) view returns (uint256)",
  "function tokenURI(uint256) view returns (string)"
];

/* =================== STATE =================== */
const STATE = { DISCONNECTED:"DISCONNECTED", WRONG_NETWORK:"WRONG_NETWORK", READY:"READY", PENDING_SIGN:"PENDING_SIGN", PENDING_MINT:"PENDING_MINT", MINTED:"MINTED" };
let appState = STATE.DISCONNECTED;

let selectedProvider = null;
let discovered = [];                    // [{provider, info}]
const LS_KEY = "dave_wallet_choice";

let provider, signer, user, onCorrectChain=false;
let autoConnectAfterChoose = false;
let connecting = false;
let sessionId = 0;

/* =================== DOM HELPERS =================== */
const $ = id => document.getElementById(id);
const setStatus = msg => $("status").innerHTML = msg || "";
const setBanner = (show,msg)=>{ const b=$("banner"); if(show){b.style.display="block";b.textContent=msg}else{b.style.display="none";b.textContent=""} };

function setButton(state){
  appState=state; const btn=$("primary");
  if(state===STATE.DISCONNECTED){btn.textContent="CONNECT WALLET";btn.disabled=false;btn.onclick=onPrimaryClick;return;}
  if(state===STATE.WRONG_NETWORK){btn.textContent="SWITCH TO BASE SEPOLIA";btn.disabled=false;btn.onclick=async()=>{const ok=await attemptSwitchNetwork(); if(!ok) setStatus("Open your wallet and switch/add Base Sepolia (chainId 84532).");};return;}
  if(state===STATE.READY){btn.textContent="MINT";btn.disabled=false;btn.onclick=onPrimaryClick;return;}
  if(state===STATE.PENDING_SIGN){btn.textContent="WORKING…";btn.disabled=true;btn.onclick=null;return;}
  if(state===STATE.PENDING_MINT){btn.textContent="MINTING…";btn.disabled=true;btn.onclick=null;return;}
  if(state===STATE.MINTED){btn.textContent="MINTED";btn.disabled=true;btn.onclick=null;return;}
}

function showPreviewTile(){ $("tile").innerHTML = `<div id="previewText" style="font-size:24px;color:#F3F3F3;">i_am_(yourName)_dave</div>`; }
function showNftTile(src){ $("tile").innerHTML = `<img id="nftImg" alt="Your NFT" src="${src}">`; }

function updatePreview(){
  const v=$("name").value.trim();
  $("count").textContent=`${v.length}/14`;
  if(appState!==STATE.MINTED){
    $("previewText").textContent = v ? `i_am_${v}_dave` : "i_am_(yourName)_dave";
  }
}
function normalizeInput(e){
  const before=e.target.value;
  const after=before.toLowerCase().replace(/[^a-z0-9-]/g,"").slice(0,14);
  if(before!==after) e.target.value=after;
  updatePreview();
}

/* =================== ERROR UTIL =================== */
function decodeErrorData(data){
  try{
    const hex = typeof data === "string" ? data : data?.data || "";
    if (typeof hex === "string" && hex.startsWith("0x08c379a0")) {
      const reason = ethers.utils.defaultAbiCoder.decode(["string"], "0x"+hex.slice(10));
      return reason?.[0];
    }
  }catch{}
  return null;
}
function rpcMessage(err){
  if (err?.code === 4001) return "Request rejected in wallet.";
  const d = err?.data || err?.error?.data || err?.error || {};
  const reason = decodeErrorData(d?.originalError?.data || d?.data || d);
  return reason || d?.message || err?.error?.message || err?.message || "Unknown RPC error";
}

/* =================== EIP-6963 DISCOVERY =================== */
function startDiscovery(){
  discovered = [];
  window.addEventListener("eip6963:announceProvider", (event) => {
    const d = event.detail;
    if (!discovered.some(x => (x.info?.uuid && x.info.uuid===d.info.uuid) || (x.info?.rdns && x.info.rdns===d.info.rdns))) {
      discovered.push(d);
    }
  });
  try { window.dispatchEvent(new Event("eip6963:requestProvider")); } catch {}
}
function buildFallbackList(){
  const arr = [];
  const eth = window.ethereum;
  if (!eth) return arr;
  const providers = Array.isArray(eth.providers) ? eth.providers : [eth].filter(Boolean);
  providers.forEach(p => {
    const name =
      p.isMetaMask ? "MetaMask" :
      p.isCoinbaseWallet ? "Coinbase Wallet" :
      p.isBraveWallet ? "Brave Wallet" :
      p.isFrame ? "Frame" :
      p.isRabby ? "Rabby" : "Injected Wallet";
    const id = p.isMetaMask ? "metamask" :
              p.isCoinbaseWallet ? "coinbase" :
              p.isBraveWallet ? "brave" :
              p.isFrame ? "frame" :
              p.isRabby ? "rabby" : "injected";
    arr.push({ provider:p, info:{ name, rdns:id, uuid:id }});
  });
  return arr;
}

/* ====== Modal (accessible) ====== */
let lastFocusedEl = null;
function getFocusableWithin(node){
  return node.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
}
function openChooser(autoconnect=false){
  autoConnectAfterChoose = autoconnect;
  lastFocusedEl = document.activeElement;
  let list = discovered.length ? discovered : buildFallbackList();
  const grid = $("chooserList");
  grid.innerHTML = "";
  if (!list.length){
    grid.innerHTML = `<div class="hint">No browser wallet detected. Install <a class="link" href="https://metamask.io" target="_blank" rel="noopener">MetaMask</a> or enable your extension, then reopen the chooser.</div>`;
  } else {
    // Sort common wallets first
    const priority = ["metamask","coinbase","rabby","brave","frame"];
    list.sort((a,b)=>{
      const ra = priority.indexOf(a.info?.rdns); const rb = priority.indexOf(b.info?.rdns);
      return (ra===-1?999:ra) - (rb===-1?999:rb);
    });
    list.forEach((d) => {
      const item = document.createElement("button");
      item.className = "prov";
      item.setAttribute("aria-label", `Connect with ${d.info?.name || "wallet"}`);
      const icon = d.info?.icon || "";
      const name = d.info?.name || "Wallet";
      const sub  = d.info?.rdns || "";
      item.innerHTML = `${icon?`<img src="${icon}" alt="">`:``}<div><div class="provname">${name}</div><div class="provsub">${sub}</div></div>`;
      item.onclick = () => useProvider(d, true);
      grid.appendChild(item);
    });
  }
  $("overlay").style.display="flex";
  // focus first provider
  const focusables = getFocusableWithin($("modal"));
  focusables[0]?.focus();
  // trap focus
  $("overlay").addEventListener("keydown", trapFocus);
}
function closeChooser(){
  $("overlay").style.display="none";
  $("overlay").removeEventListener("keydown", trapFocus);
  lastFocusedEl?.focus();
}
function trapFocus(e){
  if (e.key === "Escape") { e.preventDefault(); closeChooser(); return; }
  if (e.key !== "Tab") return;
  const focusables = Array.from(getFocusableWithin($("modal")));
  if (!focusables.length) return;
  const first = focusables[0];
  const last = focusables[focusables.length-1];
