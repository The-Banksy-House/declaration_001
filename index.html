<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Declaration of the Daves - Sign the Contract</title>
    
    <!-- Allow embedding in iframes -->
    <meta http-equiv="X-Frame-Options" content="ALLOWALL">
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0d1117;
            color: #c9d1d9;
            font-family: 'JetBrains Mono', monospace;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .widget-container {
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Main contract container - square format */
        .contract-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            width: 100%;
            aspect-ratio: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .contract-header {
            background: #0d1117;
            border-bottom: 1px solid #30363d;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-icon {
            color: #7ee787;
        }
        
        .filename {
            color: #f0f6fc;
            font-size: 14px;
        }
        
        .network-badge {
            margin-left: auto;
            background: #1f6feb;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .code-editor {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            padding: 40px 0;
        }
        
        .line-numbers {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            text-align: right;
            color: #484f58;
            font-size: 12px;
            line-height: 20px;
            user-select: none;
        }
        
        .code-content {
            margin-left: 70px;
            margin-right: 40px;
            font-size: 12px;
            line-height: 20px;
            width: calc(100% - 110px);
        }
        
        /* Syntax highlighting */
        .comment {
            color: #8b949e;
            font-style: italic;
        }
        
        .keyword {
            color: #ff7b72;
        }
        
        .function-name {
            color: #d2a8ff;
        }
        
        .type {
            color: #79c0ff;
        }
        
        .string {
            color: #a5d6ff;
        }
        
        .parameter {
            color: #ffa657;
        }
        
        .address {
            color: #7ee787;
            font-size: 12px;
            word-break: break-all;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .number {
            color: #79c0ff;
        }
        
        /* Input styling */
        .input-line {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 8px 0;
            display: inline-flex;
            align-items: center;
            transition: border-color 0.2s;
            white-space: nowrap;
        }
        
        .input-line:hover {
            border-color: #58a6ff;
        }
        
        .input-line.focused {
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        .input-prefix, .input-suffix {
            color: #a5d6ff;
            font-size: 12px;
        }
        
        .name-input {
            background: none;
            border: none;
            color: #a5d6ff;
            font-family: inherit;
            font-size: 12px;
            outline: none;
            width: 140px;
            margin: 0 4px;
        }
        
        /* Preview section */
        .preview-comment {
            margin-top: 16px;
            padding: 8px;
            background: #0d1117;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .preview-comment .comment {
            font-size: 12px;
        }
        
        .preview-comment .string {
            font-size: 12px;
        }
        
        /* Action section */
        .action-section {
            background: #0d1117;
            border-top: 1px solid #30363d;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .contract-info {
            font-size: 12px;
        }
        
        .contract-label {
            color: #8b949e;
            margin-bottom: 4px;
        }
        
        .contract-address-link {
            color: #7ee787;
            text-decoration: none;
            transition: opacity 0.2s;
        }
        
        .contract-address-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
        
        .execute-button {
            background: #f78166;
            color: #0d1117;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .execute-button:hover:not(:disabled) {
            background: #ff8c73;
            transform: translateY(-1px);
        }
        
        .execute-button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .execute-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Connected status */
        .wallet-status {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            color: #7ee787;
            display: none;
            align-items: center;
            gap: 6px;
        }
        
        .wallet-status.connected {
            display: flex;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #7ee787;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Error state */
        .error-message {
            background: #f85149;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin: 8px 0;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* NFT Preview - Square format */
        .nft-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            width: 100%;
            aspect-ratio: 1;
            margin: 40px auto 20px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .nft-container.show {
            display: flex;
        }
        
        .nft-code-editor {
            position: relative;
            width: 100%;
            padding: 40px 0;
        }
        
        .nft-line-numbers {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            text-align: right;
            color: #484f58;
            font-size: 12px;
            line-height: 20px;
            user-select: none;
        }
        
        .nft-code-content {
            margin-left: 70px;
            margin-right: 40px;
            font-size: 12px;
            line-height: 20px;
        }
        
        /* Mint button */
        .mint-button-container {
            text-align: center;
            margin-bottom: 40px;
            display: none;
        }
        
        .mint-button-container.show {
            display: block;
        }
        
        .mint-button {
            background: #f78166;
            color: #0d1117;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mint-button:hover {
            background: #ff8c73;
            transform: translateY(-1px);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #0d1117;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            .contract-container {
                border-radius: 0;
            }
            
            .code-content {
                font-size: 11px;
            }
            
            .name-input {
                font-size: 11px;
                width: 120px;
            }
            
            .execute-button {
                font-size: 12px;
                padding: 8px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <!-- Main Widget -->
        <div class="contract-container">
            <!-- Header -->
            <div class="contract-header">
                <span class="file-icon">📄</span>
                <span class="filename">DeclarationOfTheDaves.sol</span>
                <span class="network-badge">Base Mainnet</span>
            </div>
            
            <!-- Wallet Status -->
            <div class="wallet-status" id="walletStatus">
                <span class="status-dot"></span>
                <span id="walletAddress">Connected</span>
            </div>
            
            <!-- Code Editor -->
            <div class="code-editor">
                <div class="line-numbers">
                    <div>1</div>
                    <div>2</div>
                    <div>3</div>
                    <div>4</div>
                    <div>5</div>
                    <div>6</div>
                    <div>7</div>
                    <div>8</div>
                    <div>9</div>
                    <div>10</div>
                    <div>11</div>
                    <div>12</div>
                    <div>13</div>
                    <div>14</div>
                    <div>15</div>
                    <div>16</div>
                    <div>17</div>
                </div>
                
                <div class="code-content">
                    <div><span class="keyword">pragma</span> <span class="type">solidity</span> ^0.8.19;</div>
                    <br>
                    <div class="comment">/**</div>
                    <div class="comment"> * @title THE DECLARATION OF THE DAVES 001</div>
                    <div class="comment"> * @notice THE BANKSY STAYS ON THE WALL</div>
                    <div class="comment"> * @dev This contract is the art. Immutable. Permanent. Public.</div>
                    <div class="comment"> * @dev Co-sign the declaration by calling this function</div>
                    <div class="comment"> */</div>
                    <br>
                    <div><span class="keyword">function</span> <span class="function-name">cosignDeclaration</span>(<span class="type">string</span> <span class="type">memory</span> <span class="parameter">chosenName</span>) <span class="keyword">public</span> {</div>
                    <div style="margin-left: 20px;">
                        <div class="comment">// Enter your chosen name (lowercase, max 14 chars)</div>
                        <div class="input-line" id="inputLine" onclick="focusInput()">
                            <span class="input-prefix">require(chosenName == "</span>
                            <input type="text" class="name-input" id="nameInput" placeholder="your_name" maxlength="14" autocomplete="off" spellcheck="false">
                            <span class="input-suffix">", "Enter name");</span>
                        </div>
                        <div class="preview-comment">
                            <span class="comment">// Your signature will be: </span>
                            <span class="string" id="preview">i_am_your_name_dave</span>
                        </div>
                    </div>
                    <div>}</div>
                    
                    <div class="error-message" id="errorMsg">
                        ⚠️ <span id="errorText">Name can only contain lowercase letters, numbers, and hyphens</span>
                    </div>
                </div>
            </div>
            
            <!-- Action Section -->
            <div class="action-section">
                <div class="contract-info">
                    <div class="contract-label">Contract</div>
                    <a href="https://basescan.org/address/0xB0731E7ea189c169640Fd890E5dcE9811040D0eA#code" 
                       target="_blank" 
                       rel="noopener noreferrer" 
                       class="contract-address-link">
                        0xB0731E7ea189c169640Fd890E5dcE9811040D0eA
                    </a>
                </div>
                <button class="execute-button" id="executeButton">CONNECT WALLET</button>
            </div>
        </div>
        
        <!-- NFT Preview (hidden until transaction complete) -->
        <div class="nft-container" id="nftPreview">
            <div class="nft-code-editor">
                <div class="nft-line-numbers">
                    <div>1</div>
                    <div>2</div>
                    <div>3</div>
                    <div>4</div>
                    <div>5</div>
                    <div>6</div>
                    <div>7</div>
                    <div>8</div>
                    <div>9</div>
                    <div>10</div>
                    <div>11</div>
                    <div>12</div>
                    <div>13</div>
                    <div>14</div>
                </div>
                
                <div class="nft-code-content" id="nftContent">
                    <!-- NFT content will be populated dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Mint Button (hidden until transaction complete) -->
        <div class="mint-button-container" id="mintButtonContainer">
            <button class="mint-button" id="mintButton">MINT AS NFT</button>
        </div>
    </div>

    <script>
        // Load ethers.js with better error handling
        function loadEthers(callback) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
            script.onload = callback;
            script.onerror = function() {
                // Try alternative CDN
                const altScript = document.createElement('script');
                altScript.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
                altScript.onload = callback;
                altScript.onerror = function() {
                    showError('Failed to load Web3 library. Please refresh the page.');
                };
                document.head.appendChild(altScript);
            };
            document.head.appendChild(script);
        }
        
        // Initialize widget after ethers loads
        loadEthers(function() {
            console.log('[Dave Contract] Ethers loaded successfully');
            
            // Contract details
            const CONTRACT_ADDRESS = '0xB0731E7ea189c169640Fd890E5dcE9811040D0eA';
            const BASE_CHAIN_ID = '0x2105'; // 8453 in hex
            const BASE_CHAIN_ID_DEC = 8453;
            
            const CONTRACT_ABI = [
                "function cosignDeclaration(string memory chosenName) public",
                "function hasSigned(address) public view returns (bool)",
                "function signatureByAddress(address) public view returns (string)",
                "function nameExists(string) public view returns (bool)",
                "function isAllowlistActive() public view returns (bool)",
                "function timeUntilPublic() public view returns (uint256)",
                "event DeclarationSigned(address indexed signatory, string daveName, uint256 signatureNumber, uint256 blockNumber)"
            ];
            
            // State
            let provider = null;
            let signer = null;
            let contract = null;
            let connected = false;
            let userAddress = null;
            
            // Elements
            const executeButton = document.getElementById('executeButton');
            const nameInput = document.getElementById('nameInput');
            const errorMsg = document.getElementById('errorMsg');
            const errorText = document.getElementById('errorText');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const preview = document.getElementById('preview');
            const inputLine = document.getElementById('inputLine');
            const nftPreview = document.getElementById('nftPreview');
            const nftContent = document.getElementById('nftContent');
            const mintButtonContainer = document.getElementById('mintButtonContainer');
            
            // Focus input helper
            window.focusInput = function() {
                nameInput.focus();
            };
            
            // Input handlers
            nameInput.addEventListener('focus', () => {
                inputLine.classList.add('focused');
            });
            
            nameInput.addEventListener('blur', () => {
                inputLine.classList.remove('focused');
            });
            
            nameInput.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                e.target.value = value;
                
                if (value) {
                    preview.textContent = `i_am_${value}_dave`;
                } else {
                    preview.textContent = 'i_am_your_name_dave';
                }
                
                // Clear error on typing
                errorMsg.classList.remove('show');
            });
            
            // Error handling
            function showError(message) {
                console.error('[Dave Contract] Error:', message);
                errorText.textContent = message;
                errorMsg.classList.add('show');
                setTimeout(() => {
                    errorMsg.classList.remove('show');
                }, 7000);
            }
            
            function clearMessages() {
                errorMsg.classList.remove('show');
            }
            
            // Generate NFT preview content
            function generateNFTPreview(daveName, signatureNumber, blockNumber, txHash, signerAddr) {
                const shortName = daveName.replace('i_am_', '').replace('_dave', '');
                return `<div class="comment">/**</div>
<div class="comment"> * @title THE DECLARATION OF THE DAVES 001</div>
<div class="comment"> * Contract: 0xB0731E7ea189c169640Fd890E5dcE9811040D0eA</div>
<div class="comment"> * @notice THE BANKSY STAYS ON THE WALL</div>
<div class="comment"> * Signed by: <span class="number">${shortName}_dave</span></div>
<div class="comment"> */</div>
<br>
<div class="comment">// Signature Number: <span class="number">#${signatureNumber}</span></div>
<div class="comment">// Block Number: <span class="number">${blockNumber}</span></div>
<br>
<div class="comment">// Transaction Hash:</div>
<div class="address">${txHash}</div>
<br>
<div class="comment">// Signer Address:</div>
<div class="address">${signerAddr}</div>`;
            }
            
            // Connect wallet
            async function connectWallet() {
                try {
                    clearMessages();
                    console.log('[Dave Contract] Starting connection...');
                    
                    // Check for wallet
                    if (typeof window.ethereum === 'undefined') {
                        showError('Please install MetaMask or another Web3 wallet');
                        return;
                    }
                    
                    executeButton.disabled = true;
                    executeButton.innerHTML = 'CONNECTING...';
                    
                    // Request accounts
                    let accounts;
                    try {
                        accounts = await window.ethereum.request({ 
                            method: 'eth_requestAccounts' 
                        });
                        console.log('[Dave Contract] Accounts:', accounts);
                    } catch (err) {
                        if (err.code === -32002) {
                            showError('Please unlock MetaMask');
                        } else if (err.code === 4001) {
                            showError('Connection rejected');
                        } else {
                            showError('Failed to get accounts');
                        }
                        executeButton.disabled = false;
                        executeButton.innerHTML = 'CONNECT WALLET';
                        return;
                    }
                    
                    if (!accounts || accounts.length === 0) {
                        throw new Error('No accounts found');
                    }
                    
                    // Get current chain
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    console.log('[Dave Contract] Current chain:', chainId);
                    
                    // Switch to Base if needed
                    if (chainId !== BASE_CHAIN_ID) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: BASE_CHAIN_ID }],
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                try {
                                    await window.ethereum.request({
                                        method: 'wallet_addEthereumChain',
                                        params: [{
                                            chainId: BASE_CHAIN_ID,
                                            chainName: 'Base',
                                            nativeCurrency: {
                                                name: 'Ether',
                                                symbol: 'ETH',
                                                decimals: 18
                                            },
                                            rpcUrls: ['https://mainnet.base.org'],
                                            blockExplorerUrls: ['https://basescan.org/']
                                        }],
                                    });
                                } catch (addError) {
                                    showError('Please add Base network to your wallet');
                                    executeButton.disabled = false;
                                    executeButton.innerHTML = 'CONNECT WALLET';
                                    return;
                                }
                            } else {
                                showError('Please switch to Base network');
                                executeButton.disabled = false;
                                executeButton.innerHTML = 'CONNECT WALLET';
                                return;
                            }
                        }
                    }
                    
                    // Setup provider
                    provider = new window.ethers.providers.Web3Provider(window.ethereum);
                    const network = await provider.getNetwork();
                    console.log('[Dave Contract] Network:', network);
                    
                    if (network.chainId !== BASE_CHAIN_ID_DEC) {
                        throw new Error('Wrong network after switch');
                    }
                    
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    console.log('[Dave Contract] User address:', userAddress);
                    
                    // Setup contract
                    contract = new window.ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    
                    // Check if already signed
                    try {
                        const hasSigned = await contract.hasSigned(userAddress);
                        if (hasSigned) {
                            const signature = await contract.signatureByAddress(userAddress);
                            showError(`Already signed as: ${signature}`);
                            executeButton.disabled = false;
                            executeButton.innerHTML = 'CONNECT WALLET';
                            return;
                        }
                    } catch (err) {
                        console.error('[Dave Contract] Error checking signature:', err);
                    }
                    
                    // Success
                    connected = true;
                    executeButton.innerHTML = 'EXECUTE TRANSACTION';
                    executeButton.disabled = false;
                    walletAddress.textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                    walletStatus.classList.add('connected');
                    console.log('[Dave Contract] Connection successful!');
                    
                } catch (error) {
                    console.error('[Dave Contract] Connection error:', error);
                    executeButton.disabled = false;
                    executeButton.innerHTML = 'CONNECT WALLET';
                    showError('Connection failed. Please try again.');
                }
            }
            
            // Sign declaration
            async function signDeclaration() {
                try {
                    clearMessages();
                    
                    const name = nameInput.value.trim().toLowerCase();
                    
                    // Validate
                    if (!name) {
                        showError('Please enter a name');
                        return;
                    }
                    
                    if (name.length > 14) {
                        showError('Name cannot exceed 14 characters');
                        return;
                    }
                    
                    if (!/^[a-z0-9-]+$/.test(name)) {
                        showError('Only lowercase letters, numbers, and hyphens allowed');
                        return;
                    }
                    
                    // Check if name exists
                    const fullName = `i_am_${name}_dave`;
                    const nameExists = await contract.nameExists(fullName);
                    if (nameExists) {
                        showError('This DAVE name is already taken');
                        return;
                    }
                    
                    // Sign
                    executeButton.disabled = true;
                    executeButton.innerHTML = 'SIGNING<span class="loading-spinner"></span>';
                    
                    const tx = await contract.cosignDeclaration(name);
                    console.log('[Dave Contract] Transaction sent:', tx.hash);
                    
                    executeButton.innerHTML = 'CONFIRMING<span class="loading-spinner"></span>';
                    
                    const txReceipt = await tx.wait();
                    console.log('[Dave Contract] Transaction confirmed');
                    
                    // Get signature number from event
                    let signatureNumber = 'N/A';
                    const event = txReceipt.events?.find(e => e.event === 'DeclarationSigned');
                    if (event) {
                        signatureNumber = event.args.signatureNumber.toString();
                    }
                    
                    // Update UI to show NFT preview
                    nameInput.value = '';
                    document.querySelector('.preview-comment .comment').textContent = '// ';
                    preview.textContent = 'THE BANKSY STAYS ON THE WALL';
                    executeButton.innerHTML = 'SIGNED';
                    executeButton.disabled = true;
                    
                    // Generate and show NFT preview
                    nftContent.innerHTML = generateNFTPreview(
                        fullName,
                        signatureNumber,
                        txReceipt.blockNumber,
                        tx.hash,
                        userAddress
                    );
                    
                    nftPreview.classList.add('show');
                    mintButtonContainer.classList.add('show');
                    
                } catch (error) {
                    console.error('[Dave Contract] Sign error:', error);
                    executeButton.disabled = false;
                    executeButton.innerHTML = 'EXECUTE TRANSACTION';
                    
                    if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                        showError('Transaction cancelled');
                    } else if (error.message?.includes('allowlisted')) {
                        showError('Only allowlisted addresses can sign during this period');
                    } else {
                        showError('Transaction failed. Please try again.');
                    }
                }
            }
            
            // Button handler
            executeButton.addEventListener('click', async () => {
                if (!connected) {
                    await connectWallet();
                } else {
                    await signDeclaration();
                }
            });
            
            // Enter key
            nameInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && connected) {
                    await signDeclaration();
                }
            });
            
            // Listen for account/network changes
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        connected = false;
                        executeButton.innerHTML = 'CONNECT WALLET';
                        executeButton.disabled = false;
                        walletStatus.classList.remove('connected');
                        clearMessages();
                    } else if (connected && accounts[0].toLowerCase() !== userAddress.toLowerCase()) {
                        connected = false;
                        connectWallet();
                    }
                });
                
                window.ethereum.on('chainChanged', (chainId) => {
                    if (connected && chainId !== BASE_CHAIN_ID) {
                        showError('Please switch back to Base network');
                        connected = false;
                        executeButton.innerHTML = 'CONNECT WALLET';
                        executeButton.disabled = false;
                    }
                });
            }
            
            // Auto-focus input
            nameInput.focus();
        });
    </script>
</body>
</html>
