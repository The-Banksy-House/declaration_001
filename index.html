<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Declaration of the Daves - Sign the Contract</title>

  <!-- Allow embedding in iframes -->
  <meta http-equiv="X-Frame-Options" content="ALLOWALL">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0d1117; color: #c9d1d9; font-family: 'JetBrains Mono', monospace;
      min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .widget-container { max-width: 600px; margin: 0 auto; width: 100%; }

    /* Main contract container - square format */
    .contract-container {
      background: #161b22; border: 1px solid #30363d; border-radius: 6px; width: 100%;
      aspect-ratio: 1; overflow: hidden; display: flex; flex-direction: column;
    }
    .contract-header {
      background: #0d1117; border-bottom: 1px solid #30363d; padding: 12px 20px;
      display: flex; align-items: center; gap: 8px;
    }
    .file-icon { color: #7ee787; }
    .filename { color: #f0f6fc; font-size: 14px; }
    .network-badge { margin-left: auto; background: #1f6feb; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; }

    .code-editor { flex: 1; position: relative; display: flex; align-items: center; padding: 40px 0; }
    .line-numbers {
      position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
      width: 30px; text-align: right; color: #484f58; font-size: 12px; line-height: 20px; user-select: none;
    }
    .code-content {
      margin-left: 70px; margin-right: 40px; font-size: 12px; line-height: 20px; width: calc(100% - 110px);
      /* mobile overflow guards */
      overflow-wrap: anywhere; word-break: break-word;
    }

    /* Syntax highlighting */
    .comment { color: #8b949e; font-style: italic; }
    .keyword { color: #ff7b72; }
    .function-name { color: #d2a8ff; }
    .type { color: #79c0ff; }
    .string { color: #a5d6ff; }
    .parameter { color: #ffa657; }
    .address { color: #7ee787; font-size: 12px; word-break: break-word; font-family: 'JetBrains Mono', monospace; }
    .number { color: #79c0ff; }

    /* Input styling */
    .input-line { background: #0d1117; border: 1px solid #30363d; border-radius: 4px; padding: 8px 12px; margin: 8px 0;
      display: inline-flex; align-items: center; transition: border-color 0.2s; white-space: nowrap; }
    .input-line:hover { border-color: #58a6ff; }
    .input-line.focused { border-color: #58a6ff; box-shadow: 0 0 0 3px rgba(88,166,255,.1); }
    .input-line.disabled { opacity: .5; cursor: not-allowed; }
    .input-prefix, .input-suffix { color: #a5d6ff; font-size: 12px; }
    .name-input { background: none; border: none; color: #a5d6ff; font-family: inherit; font-size: 12px; outline: none; width: 140px; margin: 0 4px; }

    /* Preview section */
    .preview-comment { margin-top: 16px; padding: 8px; background: #0d1117; border-radius: 4px; font-size: 12px; }
    .preview-comment .comment, .preview-comment .string { font-size: 12px; }

    /* Action section */
    .action-section {
      background: #0d1117; border-top: 1px solid #30363d; padding: 20px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .contract-info { font-size: 12px; }
    .contract-label { color: #8b949e; margin-bottom: 4px; }
    .contract-address-link { color: #7ee787; text-decoration: none; transition: opacity .2s; }
    .contract-address-link:hover { opacity: .8; text-decoration: underline; }
    .execute-button {
      background: #f78166; color: #0d1117; border: none; padding: 10px 24px; border-radius: 6px;
      font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; transition: all .2s;
      text-transform: uppercase; letter-spacing: .5px;
    }
    .execute-button:hover:not(:disabled){ background:#ff8c73; transform: translateY(-1px); }
    .execute-button:active:not(:disabled){ transform: translateY(0); }
    .execute-button:disabled{ opacity:.6; cursor:not-allowed; }

    /* Connected status */
    .wallet-status { position: absolute; top: 20px; right: 20px; font-size: 12px; color: #7ee787; display: none; align-items: center; gap: 6px; }
    .wallet-status.connected { display: flex; }
    .status-dot { width: 8px; height: 8px; background: #7ee787; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%{opacity:1} 50%{opacity:.5} 100%{opacity:1} }

    /* Error state */
    .error-message { background:#f85149; color:#fff; padding:8px 12px; border-radius:4px; font-size:12px; margin:8px 0; display:none; }
    .error-message.show { display:block; }

    /* NFT Preview - Square format */
    .nft-container {
      background:#161b22; border:1px solid #30363d; border-radius:6px; width:100%; aspect-ratio:1;
      margin:40px auto 20px; display:none; align-items:center; justify-content:center;
    }
    .nft-container.show { display:flex; }
    .nft-code-editor { position:relative; width:100%; padding:40px 0; }
    .nft-line-numbers {
      position:absolute; left:20px; top:50%; transform: translateY(-50%);
      width:30px; text-align:right; color:#484f58; font-size:12px; line-height:20px; user-select:none;
    }
    .nft-code-content { margin-left:70px; margin-right:40px; font-size:12px; line-height:20px; overflow-wrap:anywhere; word-break:break-word; }

    /* Mint button */
    .mint-button-container { text-align:center; margin-bottom:40px; display:none; }
    .mint-button-container.show { display:block; }
    .mint-button {
      background:#f78166; color:#0d1117; border:none; padding:10px 24px; border-radius:6px;
      font-family:inherit; font-size:14px; font-weight:600; cursor:pointer; transition:all .2s;
      text-transform:uppercase; letter-spacing:.5px;
    }
    .mint-button:hover:not(:disabled){ background:#ff8c73; transform: translateY(-1px); }
    .mint-button:disabled{ opacity:.6; cursor:not-allowed; }
    .loading-spinner { display:inline-block; width:14px; height:14px; border:2px solid #0d1117; border-radius:50%; border-top-color:transparent; animation: spin .8s linear infinite; margin-left:8px; vertical-align:middle; }
    @keyframes spin { to{ transform: rotate(360deg); } }

    /* Success message */
    .success-message { background:#238636; color:#fff; padding:12px; border-radius:6px; font-size:12px; margin:20px 0; text-align:center; display:none; }
    .success-message.show { display:block; }
    .success-message a { color:#7ee787; text-decoration:none; }
    .success-message a:hover { text-decoration:underline; }

    @media (max-width: 600px) {
      .contract-container { border-radius: 0; }
      .code-content { font-size: 11px; }
      .name-input { font-size: 11px; width: 120px; }
      .execute-button { font-size: 12px; padding: 8px 20px; }
    }
  </style>
</head>
<body>
  <div class="widget-container">
    <!-- Main Widget -->
    <div class="contract-container">
      <!-- Header -->
      <div class="contract-header">
        <span class="file-icon">üìÑ</span>
        <span class="filename">DeclarationOfTheDaves.sol</span>
        <span class="network-badge">Base Mainnet</span>
      </div>

      <!-- Wallet Status -->
      <div class="wallet-status" id="walletStatus">
        <span class="status-dot"></span>
        <span id="walletAddress">Connected</span>
      </div>

      <!-- Code Editor -->
      <div class="code-editor">
        <div class="line-numbers">
          <div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div>
        </div>

        <div class="code-content">
          <div><span class="keyword">pragma</span> <span class="type">solidity</span> ^0.8.19;</div>
          <br>
          <div class="comment">/**</div>
          <div class="comment"> * @title THE DECLARATION OF THE DAVES 001</div>
          <div class="comment"> * @notice THE BANKSY STAYS ON THE WALL</div>
          <div class="comment"> * @dev This contract is the art. Immutable. Permanent. Public.</div>
          <div class="comment"> * @dev Co-sign the declaration by calling this function</div>
          <div class="comment"> */</div>
          <br>
          <div><span class="keyword">function</span> <span class="function-name">cosignDeclaration</span>(<span class="type">string</span> <span class="type">memory</span> <span class="parameter">chosenName</span>) <span class="keyword">public</span> {</div>
          <div style="margin-left: 20px;">
            <div class="comment">// Enter your chosen name (lowercase, max 14 chars)</div>
            <div class="input-line" id="inputLine" onclick="focusInput()">
              <span class="input-prefix">require(chosenName == "</span>
              <input type="text" class="name-input" id="nameInput" placeholder="your_name" maxlength="14" autocomplete="off" spellcheck="false">
              <span class="input-suffix">", "Enter name");</span>
            </div>
            <div class="preview-comment">
              <span class="comment">// Your signature will be: </span>
              <span class="string" id="preview">i_am_your_name_dave</span>
            </div>
          </div>
          <div>}</div>

          <div class="error-message" id="errorMsg">
            ‚ö†Ô∏è <span id="errorText">Name can only contain lowercase letters, numbers, and hyphens</span>
          </div>
        </div>
      </div>

      <!-- Action Section -->
      <div class="action-section">
        <div class="contract-info">
          <div class="contract-label">Contract</div>
          <a href="https://basescan.org/address/0xB0731E7ea189c169640Fd890E5dcE9811040D0eA#code"
             target="_blank" rel="noopener noreferrer" class="contract-address-link">
            0xB0731E7ea189c169640Fd890E5dcE9811040D0eA
          </a>
        </div>
        <button class="execute-button" id="executeButton">CONNECT WALLET</button>
      </div>
    </div>

    <!-- NFT Preview -->
    <div class="nft-container" id="nftPreview">
      <div class="nft-code-editor">
        <div class="nft-line-numbers">
          <div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div>
        </div>
        <div class="nft-code-content" id="nftContent"></div>
      </div>
    </div>

    <!-- Mint Button -->
    <div class="mint-button-container" id="mintButtonContainer">
      <button class="mint-button" id="mintButton" disabled title="Mint will be enabled after NFT contract is deployed">MINT AS NFT (0.001439 ETH)</button>
    </div>

    <!-- Success Message -->
    <div class="success-message" id="successMessage">
      <div id="successText">NFT Minted Successfully!</div>
      <div style="margin-top: 8px;">
        <a id="openSeaLink" href="#" target="_blank" rel="noopener noreferrer">View on OpenSea ‚Üí</a>
      </div>
    </div>
  </div>

  <!-- ethers v5 -->
  <script>
    function loadEthers(callback){
      const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
      s.onload=callback; s.onerror=function(){ const a=document.createElement('script'); a.src='https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js'; a.onload=callback; a.onerror=function(){showError('Failed to load Web3 library. Please refresh.')} ; document.head.appendChild(a); };
      document.head.appendChild(s);
    }
  </script>

  <script>
    loadEthers(function () {
      // --- Constants ---
      const CONTRACT_ADDRESS = '0xB0731E7ea189c169640Fd890E5dcE9811040D0eA';
      const NFT_CONTRACT_ADDRESS = ''; // keep empty until deployed
      const BASE_CHAIN_ID = '0x2105'; // 8453 hex
      const BASE_CHAIN_ID_DEC = 8453;

      const CONTRACT_ABI = [
        "function cosignDeclaration(string) public",
        "function hasSigned(address) public view returns (bool)",
        "function signatureByAddress(address) public view returns (string)",
        "function readInstructions() public pure returns (string)",
        "function getInscriptionDetails() public view returns (address,uint256,uint256)",
        "event DeclarationSigned(address indexed signatory, string daveName, uint256 signatureNumber, uint256 blockNumber)"
      ];

      const NFT_CONTRACT_ABI = [
        "function mint(bytes32 _originalTxHash, uint256 _signatureNumber, uint256 _blockNumber) public payable",
        "function hasMinted(address) public view returns (bool)",
        "function addressToTokenId(address) public view returns (uint256)",
        "function MINT_PRICE() public view returns (uint256)"
      ];

      // --- State ---
      let provider=null, signer=null, contract=null, nftContract=null;
      let connected=false, userAddress=null;
      let signatureData=null; // {daveName, signatureNumber, blockNumber, txHash}

      // --- Elements ---
      const executeButton = document.getElementById('executeButton');
      const nameInput = document.getElementById('nameInput');
      const errorMsg = document.getElementById('errorMsg');
      const errorText = document.getElementById('errorText');
      const walletStatus = document.getElementById('walletStatus');
      const walletAddress = document.getElementById('walletAddress');
      const preview = document.getElementById('preview');
      const inputLine = document.getElementById('inputLine');
      const nftPreview = document.getElementById('nftPreview');
      const nftContent = document.getElementById('nftContent');
      const mintButtonContainer = document.getElementById('mintButtonContainer');
      const mintButton = document.getElementById('mintButton');
      const successMessage = document.getElementById('successMessage');
      const successText = document.getElementById('successText');
      const openSeaLink = document.getElementById('openSeaLink');

      // helpers
      window.focusInput = function(){ if(!nameInput.disabled){ nameInput.focus(); } };
      function showError(m){ errorText.textContent=m; errorMsg.classList.add('show'); setTimeout(()=>errorMsg.classList.remove('show'),7000); }
      function clearMessages(){ errorMsg.classList.remove('show'); }

      nameInput.addEventListener('focus',()=>inputLine.classList.add('focused'));
      nameInput.addEventListener('blur',()=>inputLine.classList.remove('focused'));
      nameInput.addEventListener('input',(e)=>{ const v=e.target.value.toLowerCase(); e.target.value=v; preview.textContent = v ? `i_am_${v}_dave` : 'i_am_your_name_dave'; errorMsg.classList.remove('show'); });

      function extractDisplayName(full){ // i_am_xxx_dave -> xxx
        if (!full) return '';
        return full.replace(/^i_am_/,'').replace(/_dave$/,'');
      }

      function generateNFTPreview(daveName, signatureNumber, blockNumber, txHash, signerAddr){
        const shortName = extractDisplayName(daveName);
        const txLabel = txHash ? txHash : '0x...';
        return `<div class="comment">/**</div>
<div class="comment"> * @title THE DECLARATION OF THE DAVES 001</div>
<div class="comment"> * Contract: 0xB0731E7ea189c169640Fd890E5dcE9811040D0eA</div>
<div class="comment"> * @notice THE BANKSY STAYS ON THE WALL</div>
<div class="comment"> * Signed by: <span class="number">${shortName}_dave</span></div>
<div class="comment"> */</div>
<br>
<div class="comment">// Signature Number: <span class="number">#${signatureNumber}</span></div>
<div class="comment">// Block Number: <span class="number">${blockNumber}</span></div>
<br>
<div class="comment">// Transaction Hash:</div>
<div class="address">${txLabel}</div>
<br>
<div class="comment">// Signer Address:</div>
<div class="address">${signerAddr}</div>`;
      }

      async function ensureBase(eth){
        try {
          const id = await eth.request({ method:'eth_chainId' });
          if (id !== BASE_CHAIN_ID){
            try {
              await eth.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BASE_CHAIN_ID }] });
            } catch (e){
              if (e && e.code === 4902){
                await eth.request({ method:'wallet_addEthereumChain', params:[{
                  chainId: BASE_CHAIN_ID, chainName:'Base',
                  nativeCurrency:{ name:'Ether', symbol:'ETH', decimals:18 },
                  rpcUrls:['https://mainnet.base.org'], blockExplorerUrls:['https://basescan.org/']
                }]});
              } else { throw e; }
            }
          }
        } catch (e){ throw e; }
      }

      // New: fetch signer details via event logs (scales) instead of looping signatures[]
      async function fetchSignatureData(addr){
        // Start from inscriptionBlock to avoid scanning chain history
        const [ , inscriptionBlock ] = await (new ethers.Contract(CONTRACT_ADDRESS, ["function getInscriptionDetails() view returns (address,uint256,uint256)"], provider)).getInscriptionDetails();

        const iface = new ethers.utils.Interface(CONTRACT_ABI);
        const topic0 = iface.getEventTopic("DeclarationSigned(address,string,uint256,uint256)");
        const topicAddr = ethers.utils.hexZeroPad(addr, 32); // indexed signatory

        const logs = await provider.getLogs({
          address: CONTRACT_ADDRESS,
          fromBlock: inscriptionBlock.toNumber ? inscriptionBlock.toNumber() : inscriptionBlock, // ethers v5 BigNumber
          toBlock: 'latest',
          topics: [topic0, topicAddr]
        });

        if (!logs.length) return null;

        // Use the first (original) signature event for the address
        const log = logs[0];
        const parsed = iface.parseLog(log);
        return {
          daveName: await (new ethers.Contract(CONTRACT_ADDRESS, ["function signatureByAddress(address) view returns (string)"], provider)).signatureByAddress(addr),
          signatureNumber: parsed.args.signatureNumber.toString(),
          blockNumber: log.blockNumber,
          txHash: log.transactionHash
        };
      }

      async function connectWallet(){
        clearMessages();
        if (typeof window.ethereum === 'undefined'){ showError('Please install MetaMask or another Web3 wallet'); return; }

        executeButton.disabled = true; executeButton.innerHTML = 'CONNECTING...';
        try {
          await ensureBase(window.ethereum);
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          if (!accounts || !accounts.length) throw new Error('No accounts');

          provider = new ethers.providers.Web3Provider(window.ethereum);
          const net = await provider.getNetwork();
          if (net.chainId !== BASE_CHAIN_ID_DEC) throw new Error('Wrong network');

          signer = provider.getSigner();
          userAddress = (await signer.getAddress());
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

          if (NFT_CONTRACT_ADDRESS){ nftContract = new ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_CONTRACT_ABI, signer); }

          walletAddress.textContent = `Connected: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
          walletStatus.classList.add('connected');

          const signed = await contract.hasSigned(userAddress);
          if (signed){
            // Scalable path: event log lookup for sig number + block + tx
            signatureData = await fetchSignatureData(userAddress);
            if (!signatureData) { showError('Could not retrieve signature data'); }
            else {
              const previewHtml = generateNFTPreview(signatureData.daveName, signatureData.signatureNumber, signatureData.blockNumber, signatureData.txHash, userAddress);
              nftContent.innerHTML = previewHtml;
              nftPreview.classList.add('show');
              mintButtonContainer.classList.add('show'); // visible but disabled until NFT addr set
            }
            nameInput.disabled = true; inputLine.classList.add('disabled');
            document.querySelector('.preview-comment .comment').textContent = '// ';
            preview.textContent = 'THE BANKSY STAYS ON THE WALL';
            executeButton.innerHTML = 'ALREADY SIGNED'; executeButton.disabled = true;
            connected = true; // still connected, just not signing
          } else {
            connected = true;
            executeButton.innerHTML = 'EXECUTE TRANSACTION';
            executeButton.disabled = false;
          }
        } catch (e){
          console.error(e);
          showError(e?.message || 'Connection failed');
          executeButton.innerHTML = 'CONNECT WALLET'; executeButton.disabled = false;
        }
      }

      async function signDeclaration(){
        try {
          clearMessages();
          const name = nameInput.value.trim().toLowerCase();
          if (!name){ showError('Please enter a name'); return; }
          if (name.length > 14){ showError('Name cannot exceed 14 characters'); return; }
          if (!/^[a-z0-9-]+$/.test(name)){ showError('Only lowercase letters, numbers, and hyphens allowed'); return; }

          const fullName = `i_am_${name}_dave`;
          const nameExists = await (new ethers.Contract(CONTRACT_ADDRESS, ["function nameExists(string) view returns (bool)"], provider)).nameExists(fullName);
          if (nameExists){ showError('This DAVE name has already signed'); return; }

          executeButton.disabled = true; executeButton.innerHTML = 'SIGNING<span class="loading-spinner"></span>';
          const tx = await contract.cosignDeclaration(name);
          executeButton.innerHTML = 'CONFIRMING<span class="loading-spinner"></span>';
          const receipt = await tx.wait();

          // Read event data directly (no loops)
          const iface = new ethers.utils.Interface(CONTRACT_ABI);
          const ev = receipt.logs.map(l=>{ try { return iface.parseLog(l) } catch { return null } }).find(x=>x && x.name==='DeclarationSigned');
          const sigNum = ev ? ev.args.signatureNumber.toString() : 'N/A';

          signatureData = {
            daveName: fullName,
            signatureNumber: sigNum,
            blockNumber: receipt.blockNumber,
            txHash: tx.hash
          };

          // Lock UI and show preview
          nameInput.value=''; nameInput.disabled=true; inputLine.classList.add('disabled');
          document.querySelector('.preview-comment .comment').textContent = '// ';
          preview.textContent = 'THE BANKSY STAYS ON THE WALL';
          executeButton.innerHTML = 'SIGNED'; executeButton.disabled = true;

          nftContent.innerHTML = generateNFTPreview(fullName, sigNum, receipt.blockNumber, tx.hash, userAddress);
          nftPreview.classList.add('show'); mintButtonContainer.classList.add('show');

          // notify parent iframe for resize
          setTimeout(()=>{ if (window.parent !== window){ window.parent.postMessage({ type:'resize', height: document.body.scrollHeight }, '*'); } }, 100);
        } catch (error){
          console.error(error);
          executeButton.disabled=false; executeButton.innerHTML='EXECUTE TRANSACTION';
          if (error.code === 'ACTION_REJECTED' || error.code === 4001){ showError('Transaction cancelled'); }
          else if (error.message?.includes('allowlisted')){ showError('Only allowlisted addresses can sign during this period'); }
          else { showError('Transaction failed. Please try again.'); }
        }
      }

      async function mintNFT(){
        showError('NFT contract not deployed yet'); // placeholder by request
      }

      // Wire up buttons
      executeButton.addEventListener('click', async ()=>{ if (!connected) await connectWallet(); else await signDeclaration(); });
      mintButton.addEventListener('click', mintNFT);
      nameInput.addEventListener('keypress', async (e)=>{ if (e.key==='Enter' && connected && !nameInput.disabled){ await signDeclaration(); } });

      // Chain/account listeners
      if (window.ethereum){
        window.ethereum.on('accountsChanged', (accounts)=>{ if (!accounts.length) location.reload(); else if (connected && accounts[0].toLowerCase() !== userAddress?.toLowerCase()) location.reload(); });
        window.ethereum.on('chainChanged', (id)=>{ if (id !== BASE_CHAIN_ID){ showError('Please switch back to Base network'); executeButton.innerHTML='CONNECT WALLET'; executeButton.disabled=false; connected=false; } });
      }

      // Autofocus input
      nameInput.focus();
    });
  </script>
</body>
</html>
