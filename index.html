<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>The Banksy Declaration</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap');

        :root {
            --bg-color: #1E1E1E;
            --panel-bg: #2D2D2D;
            --text-color: #D4D4D4;
            --blue: #569CD6;
            --green: #4EC9B0;
            --yellow: #DCDCAA;
            --purple: #C586C0;
            --orange: #CE9178;
            --comment-green: #6A9955;
            --error-red: #F44747;
            --button-bg: #0E639C;
            --button-hover: #1579B8;
            --button-disabled-bg: #3A3A3A;
            --button-disabled-text: #858585;
            --border-color: #444;
            --font-family: 'Roboto Mono', monospace;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow-x: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: env(safe-area-inset-top);
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .status-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .network-badge {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            color: var(--green);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
        }

        #walletStatus {
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .contract-container {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
        }

        .contract-code {
            padding: 24px;
            flex-grow: 1;
            font-size: 1em;
            line-height: 1.6;
            overflow-y: auto;
            position: relative;
        }
        
        .code-line {
            white-space: pre-wrap;
        }

        .keyword { color: var(--blue); }
        .type { color: var(--green); }
        .name { color: var(--yellow); }
        .string-literal { color: var(--orange); }
        .comment { color: var(--comment-green); }
        .paren { color: var(--text-color); }
        .special { color: var(--purple); }

        .contract-address-link {
            color: var(--green);
            text-decoration: none;
        }
        .contract-address-link:hover {
            text-decoration: underline;
        }

        #inputLine, #inputLineMobile {
            display: flex;
            align-items: center;
        }

        #inputLineMobile { display: none; }

        .input-wrapper {
            position: relative;
            display: inline-block;
        }

        #nameInput, #nameInputMobile {
            background: none;
            border: none;
            color: var(--orange);
            font-family: var(--font-family);
            font-size: 1em;
            padding: 0;
            outline: none;
            width: 18ch;
        }

        #nameInputMobile {
            width: 100%;
        }

        .flashing-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background-color: var(--text-color);
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
            margin-left: 2px;
        }

        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: var(--text-color); }
        }

        .action-section {
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            padding: 16px 24px;
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 16px;
        }

        #walletAddress {
            color: var(--text-color);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .execute-button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px 20px;
            font-family: var(--font-family);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .execute-button:hover:not(:disabled) {
            background-color: var(--button-hover);
        }

        .execute-button:disabled {
            background-color: var(--button-disabled-bg);
            color: var(--button-disabled-text);
            cursor: not-allowed;
        }

        #errorMsg {
            background-color: rgba(244, 71, 71, 0.1);
            border: 1px solid var(--error-red);
            border-radius: 4px;
            padding: 12px;
            margin-top: 16px;
            color: var(--error-red);
            font-size: 0.9rem;
            display: none;
        }

        #successMessage {
            margin-top: 16px;
            padding: 12px;
            background-color: rgba(78, 201, 176, 0.1);
            border: 1px solid var(--green);
            color: var(--green);
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
            display: none;
        }

        .post-sign-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        #nftPreview {
            display: none;
            position: relative;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            aspect-ratio: 1 / 1;
            padding: 24px;
            box-sizing: border-box;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        #nftContent { white-space: pre; }
        .nft-label { color: var(--purple); }
        .nft-value { color: var(--text-color); }
        .nft-hash { color: var(--orange); }

        #mintButtonContainer {
            text-align: center;
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            body {
                align-items: flex-start;
                padding: 0;
            }
            .container {
                padding: 15px;
                padding-top: calc(15px + env(safe-area-inset-top));
                max-width: 100%;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .contract-container {
                aspect-ratio: auto;
                min-height: 300px;
            }
            .contract-code {
                font-size: 0.9em;
                padding: 16px;
            }
            #inputLine {
                display: none;
            }
            #inputLineMobile {
                display: flex;
            }
            .action-section {
                padding: 12px 16px;
            }
            .execute-button {
                font-size: 0.9rem;
                padding: 10px 16px;
            }
            .post-sign-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="title">Declaration.sol</div>
            <div class="status-container">
                <div class="network-badge">Base Mainnet</div>
                <div id="walletStatus">Not Connected</div>
            </div>
        </div>

        <div id="errorMsg">
            <span id="errorText"></span>
        </div>

        <div class="contract-container">
            <div class="contract-code">
                <div class="code-line"><span class="comment">// SPDX-License-Identifier: MIT</span></div>
                <div class="code-line"><span class="keyword">pragma solidity</span> ^0.8.20;</div>
                <br>
                <div class="code-line"><span class="keyword">contract</span> <span class="name">Declaration</span> {</div>
                <div class="code-line">  <span class="type">address</span> <span class="keyword">constant</span> <span class="name">banksy</span> =</div>
                <div class="code-line" style="padding-left: 1ch;"><a href="https://basescan.org/address/0xB0731E7ea189c169640Fd890E5dcE9811040D0eA" target="_blank" class="contract-address-link string-literal" id="contractAddressLink">"0xB073...D0eA"</a>;</div>
                <br>
                <div class="code-line"><span class="comment">  /**</span></div>
                <div class="code-line"><span class="comment">   * @dev Signs the declaration.</span></div>
                <div class="code-line"><span class="comment">   * your_name must be a-z, 0-9, or -</span></div>
                <div class="code-line"><span class="comment">   */</span></div>
                <div class="code-line">  <span class="keyword">function</span> <span class="name">cosignDeclaration</span><span class="paren">(</span><span class="type">string</span> <span class="keyword">calldata</span> <span class="name">your_name</span><span class="paren">)</span> <span class="keyword">public</span> {</div>
                <div id="inputLine" class="code-line" style="padding-left: 2ch;">
                    <span class="special">require</span><span class="paren">(</span><span class="name">tx.origin</span> == <span class="name">msg.sender</span>, <span class="string-literal">"Be you."</span><span class="paren">)</span>;
                </div>
                <div id="preview" class="code-line" style="padding-left: 2ch;">
                    <span class="name">declaration</span>.<span class="name">sign</span><span class="paren">(</span>
                        <div id="inputLine" style="display: inline-block; padding-left: 1ch;">
                            <span class="string-literal">"</span><input type="text" id="nameInput" maxlength="14" placeholder="your_name" autocomplete="off" spellcheck="false"><span class="string-literal">"</span>
                        </div>
                    <span class="paren">)</span>;
                </div>
                <div id="inputLineMobile" class="code-line" style="padding-left: 2ch;">
                    <span class="string-literal">"</span><input type="text" id="nameInputMobile" maxlength="14" placeholder="your_name" autocomplete="off" spellcheck="false"><span class="string-literal">"</span><div class="flashing-cursor"></div>
                </div>
                <div id="previewMobile" class="code-line" style="padding-left: 2ch;"></div>
                <div class="code-line">  }</div>
                <div class="code-line">}</div>
            </div>
            <div class="action-section">
                <div id="walletAddress"></div>
                <button id="executeButton" class="execute-button">CONNECT WALLET</button>
            </div>
        </div>
        
        <div id="successMessage">
            Declaration signed. THE BANKSY STAYS ON THE WALL.
        </div>
        
        <div class="post-sign-container">
            <div id="nftPreview">
                <div id="nftContent"></div>
            </div>
            <div id="mintButtonContainer">
                 <button id="mintButton" class="execute-button" disabled title="Minting will be enabled after the declaration period.">MINT NFT (COMING SOON)</button>
            </div>
        </div>

    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const PROJECT_ID = 'c6e735ab923e4817edde143987bdfccf';
        const CONTRACT_ADDRESS = '0xB0731E7ea189c169640Fd890E5dcE9811040D0eA';
        const NFT_CONTRACT_ADDRESS = ''; // Placeholder

        const BASE_CHAIN_ID_HEX = '0x2105';
        const BASE_CHAIN_ID_DEC = 8453;
        const BASE_NETWORK_CONFIG = {
            chainId: BASE_CHAIN_ID_HEX,
            chainName: 'Base',
            nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
            rpcUrls: ['https://mainnet.base.org'],
            blockExplorerUrls: ['https://basescan.org'],
        };

        const CONTRACT_ABI = [
            "function cosignDeclaration(string memory your_name) public",
            "function hasSigned(address) public view returns (bool)",
            "function getInscriptionDetails() public view returns (address, uint256, uint256)",
            "event DeclarationSigned(address indexed signatory, string daveName, uint256 signatureNumber, uint256 blockNumber)"
        ];

        // --- DOM ELEMENTS ---
        const executeButton = document.getElementById('executeButton');
        const walletStatus = document.getElementById('walletStatus');
        const walletAddress = document.getElementById('walletAddress');
        const nameInput = document.getElementById('nameInput');
        const nameInputMobile = document.getElementById('nameInputMobile');
        const errorMsg = document.getElementById('errorMsg');
        const errorText = document.getElementById('errorText');
        const previewDesktop = document.getElementById('preview');
        const previewMobile = document.getElementById('previewMobile');
        const successMessage = document.getElementById('successMessage');
        const nftPreview = document.getElementById('nftPreview');
        const nftContent = document.getElementById('nftContent');
        const contractAddressLink = document.getElementById('contractAddressLink');
        
        // --- STATE ---
        let provider;
        let signer;
        let userAddress;
        let contract;
        
        // --- AppKit Initialization ---
        async function initializeAppKit() {
            try {
                const { createAppKit } = await import('https://esm.sh/@reown/appkit?bundle');
                const { Ethers5Adapter } = await import('https://esm.sh/@reown/appkit-adapter-ethers5?bundle');

                const modal = await createAppKit({
                    projectId: PROJECT_ID,
                    adapter: Ethers5Adapter,
                    chains: [{
                      id: `eip155:${BASE_CHAIN_ID_DEC}`,
                      name: 'Base',
                      rpcUrl: 'https://mainnet.base.org',
                    }],
                    options: {
                      walletConnect: {
                        showQrModal: false // Prioritize deep-linking on mobile
                      }
                    }
                });
                window.daveModal = modal;
                window.__appkitReady = true;
            } catch (error) {
                console.error("AppKit initialization failed:", error);
                window.__appkitError = error.message || 'Unknown initialization error.';
            }
        }
        
        initializeAppKit();

        // --- UI & HELPER FUNCTIONS ---
        const showError = (message) => {
            errorText.textContent = message;
            errorMsg.style.display = 'block';
        };

        const hideError = () => {
            errorMsg.style.display = 'none';
        };
        
        const truncateAddress = (address) => `${address.slice(0, 6)}...${address.slice(-4)}`;

        const updateUI = async () => {
            hideError();
            if (userAddress) {
                walletStatus.textContent = `Connected: ${truncateAddress(userAddress)}`;
                walletAddress.textContent = userAddress;
                
                const hasSigned = await contract.hasSigned(userAddress);
                if (hasSigned) {
                    await showSignedState();
                } else {
                    executeButton.textContent = 'EXECUTE TRANSACTION';
                    executeButton.disabled = false;
                }
            } else {
                walletStatus.textContent = 'Not Connected';
                walletAddress.textContent = '';
                executeButton.textContent = 'CONNECT WALLET';
                executeButton.disabled = false;
            }
        };

        const showSignedState = async () => {
            nameInput.disabled = true;
            nameInputMobile.disabled = true;
            executeButton.textContent = 'SIGNED';
            executeButton.disabled = true;
            
            const newPreviewText = `<span class="name">THE BANKSY STAYS ON THE WALL</span>`;
            previewDesktop.innerHTML = newPreviewText;
            previewMobile.innerHTML = newPreviewText;
            
            successMessage.style.display = 'block';
            nftPreview.style.display = 'block';
            
            await fetchSignatureDetails();
        };

        const poll = (conditionFn, timeout, interval = 100) => {
            const startTime = Date.now();
            return new Promise((resolve, reject) => {
                const intervalId = setInterval(() => {
                    if (conditionFn()) {
                        clearInterval(intervalId);
                        resolve();
                    } else if (Date.now() - startTime > timeout) {
                        clearInterval(intervalId);
                        reject(new Error("Polling timed out."));
                    }
                }, interval);
            });
        };

        // --- WEB3 LOGIC ---
        const setupProviderAndSigner = (eip1193Provider) => {
            provider = new ethers.providers.Web3Provider(eip1193Provider, "any");
            signer = provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        };
        
        const connectWallet = async () => {
            hideError();
            executeButton.disabled = true;
            executeButton.textContent = 'CONNECTING...';

            try {
                // Case 1: Injected provider already exists
                if (window.ethereum) {
                    setupProviderAndSigner(window.ethereum);
                } else {
                // Case 2: Use AppKit modal
                    try {
                        await poll(() => window.__appkitReady || window.__appkitError, 12000);
                    } catch (e) {
                         throw new Error("Wallet connection timed out. Please refresh.");
                    }
                    
                    if (window.__appkitError) {
                        throw new Error(`AppKit initialization failed: ${window.__appkitError}`);
                    }
                    
                    const modal = window.daveModal;
                    modal.open();
                    
                    try {
                        await poll(() => modal.getWalletProvider(), 15000); // Wait for wallet interaction
                    } catch(e) {
                         modal.close();
                         throw new Error("No wallet selected or session not established.");
                    }
                    
                    const walletProvider = modal.getWalletProvider();
                    if (!walletProvider) throw new Error("Could not get wallet provider.");
                    
                    setupProviderAndSigner(walletProvider);
                }
                
                await provider.send("eth_requestAccounts", []);
                userAddress = await signer.getAddress();
                
                provider.on('network', (newNetwork, oldNetwork) => {
                    if (oldNetwork) window.location.reload();
                });

                await ensureBaseNetwork();
                await updateUI();

            } catch (error) {
                console.error("Connection failed:", error);
                showError(error.message);
                executeButton.disabled = false;
                executeButton.textContent = 'CONNECT WALLET';
            }
        };

        const ensureBaseNetwork = async () => {
            const { chainId } = await provider.getNetwork();
            if (chainId !== BASE_CHAIN_ID_DEC) {
                try {
                    await provider.send('wallet_switchEthereumChain', [{ chainId: BASE_CHAIN_ID_HEX }]);
                } catch (switchError) {
                    // This error code indicates that the chain has not been added to MetaMask.
                    if (switchError.code === 4902) {
                        try {
                            await provider.send('wallet_addEthereumChain', [BASE_NETWORK_CONFIG]);
                        } catch (addError) {
                            throw new Error("Failed to add Base network.");
                        }
                    } else {
                       throw new Error("Please switch back to Base network.");
                    }
                }
            }
             // Re-check after potential switch
            const finalChainId = (await provider.getNetwork()).chainId;
            if (finalChainId !== BASE_CHAIN_ID_DEC) {
                throw new Error("Network switch to Base was not completed.");
            }
        };

        const executeTransaction = async () => {
            hideError();
            const name = (nameInput.value || nameInputMobile.value).toLowerCase();

            // Validation
            if (!name) {
                return showError("Name cannot be empty.");
            }
            if (name.length > 14) {
                return showError("Name cannot exceed 14 characters.");
            }
            if (!/^[a-z0-9-]+$/.test(name)) {
                return showError("Name can only contain letters (a-z), numbers (0-9), and hyphens (-).");
            }

            executeButton.disabled = true;
            executeButton.textContent = 'SIGNING...';

            try {
                const tx = await contract.cosignDeclaration(name);
                executeButton.textContent = 'CONFIRMING...';
                await tx.wait();
                await showSignedState();
            } catch (error) {
                console.error("Transaction error:", error);
                if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                    showError("Transaction cancelled.");
                } else if (error.message.includes('allowlisted')) {
                    showError("Only allowlisted addresses can sign during this period.");
                } else {
                    showError("Transaction failed. See console for details.");
                }
                executeButton.disabled = false;
                executeButton.textContent = 'EXECUTE TRANSACTION';
            }
        };

        const fetchSignatureDetails = async () => {
            try {
                const [, deploymentBlock] = await contract.getInscriptionDetails();
                const eventTopic = ethers.utils.id("DeclarationSigned(address,string,uint256,uint256)");
                const addressTopic = ethers.utils.hexZeroPad(userAddress, 32);

                const logs = await provider.getLogs({
                    fromBlock: deploymentBlock.toNumber(),
                    toBlock: 'latest',
                    address: CONTRACT_ADDRESS,
                    topics: [eventTopic, addressTopic]
                });
                
                if (logs.length > 0) {
                    const log = logs[0];
                    const iface = new ethers.utils.Interface(CONTRACT_ABI);
                    const parsedLog = iface.parseLog(log);
                    
                    const { signatory, daveName, signatureNumber, blockNumber } = parsedLog.args;

                    nftContent.innerHTML = 
                        `<span class="nft-label">STATUS:</span> <span class="nft-value">CONFIRMED</span>\n` +
                        `<span class="nft-label">ADDRESS:</span> <span class="nft-hash">${truncateAddress(signatory)}</span>\n` +
                        `<span class="nft-label">NAME:</span> <span class="nft-value">"${daveName}"</span>\n` +
                        `<span class="nft-label">SIGNATURE_NO:</span> <span class="nft-value">${signatureNumber.toString()}</span>\n` +
                        `<span class="nft-label">BLOCK:</span> <span class="nft-value">${blockNumber.toString()}</span>\n` +
                        `<span class="nft-label">TX:</span> <a href="https://basescan.org/tx/${log.transactionHash}" target="_blank" class="nft-hash">${truncateAddress(log.transactionHash)}</a>`;
                } else {
                     nftContent.textContent = "Could not retrieve signature details.";
                }

            } catch (error) {
                console.error("Error fetching signature details:", error);
                nftContent.textContent = "Error loading details.";
                showError("Could not load your signature details from the chain.");
            }
        };
        
        // --- EVENT LISTENERS ---
        const handleButtonClick = async () => {
            if (!userAddress) {
                await connectWallet();
            } else {
                await executeTransaction();
            }
        };

        const syncInputs = (e) => {
            const value = e.target.value;
            if (e.target === nameInput) {
                nameInputMobile.value = value;
            } else {
                nameInput.value = value;
            }
        };
        
        executeButton.addEventListener('click', handleButtonClick);
        nameInput.addEventListener('input', syncInputs);
        nameInputMobile.addEventListener('input', syncInputs);
        
        document.addEventListener('DOMContentLoaded', () => {
            const shortAddress = truncateAddress(CONTRACT_ADDRESS);
            contractAddressLink.textContent = `"${shortAddress}"`;
            contractAddressLink.href = `https://basescan.org/address/${CONTRACT_ADDRESS}`;
        });
    </script>
</body>
</html>
