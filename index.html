<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>i_am_dave — Mint (Base Sepolia)</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --bg:#2B2B2B; --fg:#F3F3F3; --panel:#1f1f1f; --border:#3a3a3a; }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:"JetBrains Mono", monospace; }
  .wrap { max-width: 560px; margin: 0 auto; padding: 24px; display:flex; flex-direction:column; gap:16px; }
  h1 { font-size:18px; margin:0 0 6px; }
  .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .input { width:100%; background:#151515; border:1px solid var(--border); color:var(--fg); border-radius:10px; padding:12px 14px; font-family:inherit; font-size:16px; }
  .btn { background:#0c0c0c; border:1px solid var(--border); color:var(--fg); border-radius:10px; padding:12px 16px; font-size:16px; cursor:pointer; white-space:nowrap; width:100%; }
  .btn:disabled { opacity:.6; cursor:not-allowed; }
  .hint { font-size:12px; opacity:.85; }
  .nft { width:100%; aspect-ratio:1/1; background:#2B2B2B; border:1px solid var(--border); border-radius:12px; display:grid; place-items:center; overflow:hidden; }
  .nft img { max-width:90%; max-height:90%; display:block; }
  a.link { color: var(--fg); text-decoration: underline; }
  .banner { background:#3a2b2b; border:1px solid #6b3a3a; color:#f3e6e6; padding:10px 12px; border-radius:8px; display:none; }
  .right { margin-left:auto; opacity:.8; font-size:12px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
  // ---- CONFIG (Base Sepolia) ----
  const CHAIN_ID_HEX = "0x14a34"; // 84532
  const EXPLORER = "https://sepolia.basescan.org";
  const DECLARATION_ADDR = "0xB0731E7ea189c169640Fd890E5dcE9811040D0eA";
  const SBT_ADDR          = "0xe255130A9e2277640d3DfB045075a38d63a34D06";
  const DECLARATION_DEPLOY_BLOCK = 30558001;

  const DECLARATION_ABI = [
    "function hasSigned(address) view returns (bool)",
    "function cosignDeclaration(string chosenName)",
    "event DeclarationSigned(address indexed signatory, string daveName, uint256 signatureNumber, uint256 blockNumber)"
  ];
  const SBT_ABI = [
    "function claimWithSignee(uint256 signeeNumber)",
    "function tokenIdOf(address) view returns (uint256)",
    "function tokenURI(uint256) view returns (string)"
  ];

  // ---- State machine
  const STATE = {
    DISCONNECTED: "DISCONNECTED",
    WRONG_NETWORK: "WRONG_NETWORK",
    READY: "READY",            // connected + correct network + not minted
    PENDING_SIGN: "PENDING_SIGN",
    PENDING_MINT: "PENDING_MINT",
    MINTED: "MINTED"
  };
  let appState = STATE.DISCONNECTED;

  // ---- Globals
  let provider, signer, user, onCorrectChain = false, mintedTokenId = null;

  // ---- Helpers
  const $ = id => document.getElementById(id);
  const setStatus = msg => $("status").innerHTML = msg || "";
  const setBanner = (show, msg) => {
    const b = $("banner");
    if (show) { b.style.display = "block"; b.textContent = msg; }
    else { b.style.display = "none"; b.textContent = ""; }
  };

  function setButton(state) {
    const btn = $("primary");
    appState = state;

    switch (state) {
      case STATE.DISCONNECTED:
        btn.textContent = "CONNECT WALLET";
        btn.disabled = false;
        break;
      case STATE.WRONG_NETWORK:
        btn.textContent = "WRONG NETWORK";
        btn.disabled = true;
        break;
      case STATE.READY:
        btn.textContent = "MINT";
        btn.disabled = false;
        break;
      case STATE.PENDING_SIGN:
        btn.textContent = "SIGNING…";
        btn.disabled = true;
        break;
      case STATE.PENDING_MINT:
        btn.textContent = "MINTING…";
        btn.disabled = true;
        break;
      case STATE.MINTED:
        btn.textContent = "MINTED";
        btn.disabled = true;
        break;
    }
  }

  function updatePreview() {
    const v = $("name").value.trim();
    $("previewText").textContent = v ? `i_am_${v}_dave` : "i_am_(yourName)_dave";
    $("count").textContent = `${v.length}/14`;
  }

  function lowercaseFilter(e){
    const before = e.target.value;
    const filtered = before.toLowerCase().replace(/[^a-z0-9-]/g, "").slice(0,14);
    if (before !== filtered) { e.target.value = filtered; }
    updatePreview();
    // enable/disable READY state depending on validity when connected
    if (appState === STATE.READY || appState === STATE.DISCONNECTED || appState === STATE.WRONG_NETWORK) {
      // noop; mint validity is checked on click
    }
  }

  async function readChainId() {
    const id = await window.ethereum.request({ method: "eth_chainId" });
    return (id || "").toLowerCase();
  }

  function renderTile(content) {
    const box = $("tile");
    box.innerHTML = "";
    box.appendChild(content);
  }

  function makePreviewNode(text) {
    const el = document.createElement("div");
    el.style.fontSize = "24px";
    el.style.color = "#F3F3F3";
    el.textContent = text;
    return el;
  }

  function makeImageNode(src) {
    const img = document.createElement("img");
    img.id = "nftImg";
    img.alt = "Your NFT";
    img.src = src;
    return img;
  }

  // ---- Connect flow
  async function connect() {
    try {
      if (!window.ethereum) {
        setStatus('No wallet detected. Install <a class="link" href="https://metamask.io" target="_blank" rel="noopener">MetaMask</a>.');
        setButton(STATE.DISCONNECTED);
        return;
      }

      await window.ethereum.request({ method:"eth_requestAccounts" });
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      signer   = provider.getSigner();
      user     = await signer.getAddress();

      const chain = await readChainId();
      onCorrectChain = chain === CHAIN_ID_HEX;

      setStatus(`Connected: ${user.slice(0,6)}…${user.slice(-4)} • Chain: ${chain}`);

      if (!onCorrectChain) {
        setBanner(true, "Switch your wallet to Base Sepolia (84532), then press Retry.");
        setButton(STATE.WRONG_NETWORK);
        $("retry").style.display = "inline-block";
        return;
      }

      $("retry").style.display = "none";
      setBanner(false);

      // Check if already minted for this account
      const sbt = new ethers.Contract(SBT_ADDR, SBT_ABI, signer);
      try {
        const tid = await sbt.tokenIdOf(user);
        if (tid && !ethers.BigNumber.from(tid).isZero()) {
          mintedTokenId = tid.toString();
          await showNft(sbt, mintedTokenId);
          setButton(STATE.MINTED);
          return;
        }
      } catch { /* continue */ }

      // Not minted: show live preview and enable MINT
      renderTile(makePreviewNode($("name").value ? `i_am_${$("name").value}_dave` : "i_am_(yourName)_dave"));
      setButton(STATE.READY);

    } catch (err) {
      console.error(err);
      setStatus(err?.error?.message || err?.data?.message || err.message || "Connection failed");
      setButton(STATE.DISCONNECTED);
    }
  }

  async function retryChainCheck() {
    try {
      const chain = await readChainId();
      onCorrectChain = chain === CHAIN_ID_HEX;
      setStatus(`Connected: ${user ? user.slice(0,6)+"…"+user.slice(-4) : "—"} • Chain: ${chain}`);
      if (onCorrectChain) {
        setBanner(false);
        $("retry").style.display = "none";
        // either READY or MINTED depending on token
        const sbt = new ethers.Contract(SBT_ADDR, SBT_ABI, signer);
        try {
          const tid = await sbt.tokenIdOf(user);
          if (tid && !ethers.BigNumber.from(tid).isZero()) {
            mintedTokenId = tid.toString();
            await showNft(sbt, mintedTokenId);
            setButton(STATE.MINTED);
            return;
          }
        } catch {}
        renderTile(makePreviewNode($("name").value ? `i_am_${$("name").value}_dave` : "i_am_(yourName)_dave"));
        setButton(STATE.READY);
      } else {
        setBanner(true, "Still not on Base Sepolia (84532). Switch in your wallet, then press Retry.");
        setButton(STATE.WRONG_NETWORK);
      }
    } catch (err) {
      console.error(err);
      setStatus(err?.message || "Retry failed");
    }
  }

  // ---- Logs (safe windowing)
  async function getSigneeNumberViaLogs(addr) {
    const iface  = new ethers.utils.Interface(DECLARATION_ABI);
    const topic0 = iface.getEventTopic("DeclarationSigned");
    const latest = await provider.getBlockNumber();
    const STEP = 8000;

    let from = DECLARATION_DEPLOY_BLOCK > 0 ? DECLARATION_DEPLOY_BLOCK : Math.max(0, latest - STEP * 4);
    let to   = Math.min(latest, from + STEP);

    while (from <= latest) {
      try {
        const logs = await provider.getLogs({
          address: DECLARATION_ADDR,
          fromBlock: from,
          toBlock: to,
          topics: [topic0, ethers.utils.hexZeroPad(addr, 32)]
        });
        if (logs.length) {
          const parsed = iface.parseLog(logs[logs.length - 1]);
          return parsed.args.signatureNumber.toNumber();
        }
      } catch (e) {
        if (/range/i.test(e.message || "")) {
          const half = Math.max(2000, Math.floor((to - from) / 2));
          if (half < (to - from)) { to = from + half; continue; }
        }
        throw e;
      }
      from = to + 1;
      to   = Math.min(latest, from + STEP);
    }
    throw new Error("No DeclarationSigned event found for this address");
  }

  // ---- Primary button click handler (state machine)
  async function onPrimaryClick() {
    if (appState === STATE.DISCONNECTED) return connect();
    if (appState === STATE.WRONG_NETWORK) return; // wait for manual switch + Retry
    if (appState !== STATE.READY) return;

    try {
      const declaration = new ethers.Contract(DECLARATION_ADDR, DECLARATION_ABI, signer);
      const sbt         = new ethers.Contract(SBT_ADDR, SBT_ABI, signer);

      // Validate name
      const chosen = $("name").value.trim();
      if (!/^[a-z0-9-]{1,14}$/.test(chosen)) {
        setStatus("Name must be 1–14 chars, lowercase a–z, 0–9 or '-'");
        return;
      }

      // If not signed, sign
      setButton(STATE.PENDING_SIGN);
      setStatus("Signing the Declaration…");
      const hasSigned = await declaration.hasSigned(user);
      if (!hasSigned) {
        const tx = await declaration.cosignDeclaration(chosen);
        const rc = await tx.wait();
        setStatus(`Signed. <a class="link" target="_blank" rel="noopener" href="${EXPLORER}/tx/${rc.transactionHash}">View on BaseScan</a>`);
      }

      // Mint
      setButton(STATE.PENDING_MINT);
      setStatus("Minting your soulbound NFT…");
      const signeeNumber = await getSigneeNumberViaLogs(user);
      const tx2 = await sbt.claimWithSignee(signeeNumber);
      const rc2 = await tx2.wait();
      setStatus(`Minted. <a class="link" target="_blank" rel="noopener" href="${EXPLORER}/tx/${rc2.transactionHash}">View on BaseScan</a>`);

      // Render NFT in the same tile
      const tokenId = await sbt.tokenIdOf(user);
      const uri  = await sbt.tokenURI(tokenId);
      const json = atob(uri.split(",")[1]);
      const data = JSON.parse(json);

      renderTile(makeImageNode(data.image));
      $("finalName").textContent = data.name || "";
      $("links").style.display = "flex";
      setButton(STATE.MINTED);
      $("name").disabled = true;

    } catch (err) {
      console.error(err);
      setStatus(err?.error?.message || err?.data?.message || err.message || "Something went wrong");
      setButton(STATE.READY);
    }
  }

  // ---- Render NFT links after mint
  function showLinks(openseaUrl) {
    $("opensea").href = openseaUrl;
  }

  async function showNft(sbt, tokenId) {
    const uri  = await sbt.tokenURI(tokenId);
    const json = atob(uri.split(",")[1]);
    const data = JSON.parse(json);

    renderTile(makeImageNode(data.image));
    $("finalName").textContent = data.name || "";
    const opensea = `https://testnets.opensea.io/assets/base-sepolia/${SBT_ADDR}/${tokenId}`;
    $("opensea").href = opensea;
    $("links").style.display = "flex";
    $("name").disabled = true;
  }

  // ---- Wallet listeners
  function attachWalletListeners() {
    if (!window.ethereum) return;
    window.ethereum.on?.("accountsChanged", async (accounts) => {
      user = (accounts && accounts[0]) ? accounts[0] : undefined;
      setStatus(user ? `Account: ${user.slice(0,6)}…${user.slice(-4)}` : "Disconnected");
      setButton(STATE.DISCONNECTED);
      $("name").disabled = false;
      renderTile(makePreviewNode($("name").value ? `i_am_${$("name").value}_dave` : "i_am_(yourName)_dave"));
      $("links").style.display = "none";
    });
    window.ethereum.on?.("chainChanged", async (_chainId) => {
      onCorrectChain = (_chainId || "").toLowerCase() === CHAIN_ID_HEX;
      if (!onCorrectChain) {
        setBanner(true, "Switch your wallet to Base Sepolia (84532), then press Retry.");
        setButton(STATE.WRONG_NETWORK);
      } else {
        setBanner(false);
        $("retry").style.display = "none";
        if (user) setButton(STATE.READY);
      }
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    $("primary").onclick = onPrimaryClick;
    $("retry").onclick   = retryChainCheck;
    $("name").addEventListener("input", lowercaseFilter);
    updatePreview();
    attachWalletListeners();
    // initial tile
    renderTile(makePreviewNode("i_am_(yourName)_dave"));
  });
</script>
</head>
<body>
  <div class="wrap">
    <h1>i_am_dave — The Banksy Stays on the Wall (Base Sepolia)</h1>

    <div class="card">
      <div id="banner" class="banner"></div>

      <input id="name" class="input" maxlength="14" placeholder="yourname" autocomplete="off" />
      <div class="row">
        <button class="btn" id="primary">CONNECT WALLET</button>
        <button class="btn" id="retry" style="display:none; width:auto;">Retry</button>
        <div id="count" class="right">0/14</div>
      </div>

      <div id="tile" class="nft" style="margin-top:12px;"></div>

      <div id="links" class="row" style="display:none; margin-top:10px;">
        <a id="opensea" class="link" target="_blank" rel="noopener">OpenSea (may not load on testnet)</a>
      </div>

      <div id="finalName" class="hint" style="margin-top:6px;"></div>
      <div id="status" class="hint" style="margin-top:10px;"></div>
    </div>

    <div class="hint">Declaration: 0xB0731E7ea189c169640Fd890E5dcE9811040D0eA • SBT: 0xe255130A9e2277640d3DfB045075a38d63a34D06 • Base Sepolia</div>
  </div>
</body>
</html>
