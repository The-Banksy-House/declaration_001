<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>i_am_dave — Mint (Base Sepolia)</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --bg:#2B2B2B; --fg:#F3F3F3; --panel:#1f1f1f; --border:#3a3a3a; }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:"JetBrains Mono", monospace; }
  .wrap { max-width: 560px; margin: 0 auto; padding: 24px; display:flex; flex-direction:column; gap:16px; }
  h1 { font-size:18px; margin:0 0 6px; }
  .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .input { flex:1; background:#151515; border:1px solid var(--border); color:var(--fg); border-radius:10px; padding:12px 14px; font-family:inherit; font-size:16px; }
  .btn { background:#0c0c0c; border:1px solid var(--border); color:var(--fg); border-radius:10px; padding:12px 16px; font-size:16px; cursor:pointer; white-space:nowrap; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }
  .hint { font-size:12px; opacity:.85; }
  .nft { width:100%; aspect-ratio:1/1; background:#2B2B2B; border:1px solid var(--border); border-radius:12px; display:grid; place-items:center; }
  .share { display:flex; gap:10px; flex-wrap:wrap; }
  a.link { color: var(--fg); text-decoration: underline; }
  .banner { background:#3a2b2b; border:1px solid #6b3a3a; color:#f3e6e6; padding:10px 12px; border-radius:8px; display:none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
  // -------- CONFIG: Base Sepolia --------
  const CHAIN_ID_HEX = "0x14a34"; // 84532
  const EXPLORER = "https://sepolia.basescan.org";
  const DECLARATION_ADDR = "0xB0731E7ea189c169640Fd890E5dcE9811040D0eA";
  const SBT_ADDR          = "0xe255130A9e2277640d3DfB045075a38d63a34D06";

  // Declaration deploy block (Base Sepolia)
  const DECLARATION_DEPLOY_BLOCK = 30558001;

  const DECLARATION_ABI = [
    "function hasSigned(address) view returns (bool)",
    "function signatureByAddress(address) view returns (string)",
    "function getSignature(uint256) view returns (string,address,uint256,uint256)",
    "function cosignDeclaration(string chosenName)",
    "event DeclarationSigned(address indexed signatory, string daveName, uint256 signatureNumber, uint256 blockNumber)"
  ];
  const SBT_ABI = [
    "function claimWithSignee(uint256 signeeNumber)",
    "function tokenIdOf(address) view returns (uint256)",
    "function tokenURI(uint256) view returns (string)"
  ];

  // -------- State --------
  let provider, signer, user;
  let onCorrectChain = false;

  const $ = (id) => document.getElementById(id);

  function setStatus(msg) { $("status").innerHTML = msg; }
  function setBanner(show, msg) {
    const b = $("banner");
    if (show) { b.style.display = "block"; b.textContent = msg; }
    else { b.style.display = "none"; b.textContent = ""; }
  }
  function setMintEnabled(ok) { $("mint").disabled = !ok; }

  function updatePreview() {
    const v = $("name").value.trim();
    $("previewText").textContent = v ? `i_am_${v}_dave` : "i_am_(yourName)_dave";
  }

  async function readChainId() {
    const id = await window.ethereum.request({ method: "eth_chainId" });
    return (id || "").toLowerCase();
  }

  async function connect() {
    try {
      if (!window.ethereum) {
        setStatus('No wallet detected. Install <a class="link" href="https://metamask.io" target="_blank" rel="noopener">MetaMask</a> or use a wallet extension.');
        return;
      }

      await window.ethereum.request({ method:"eth_requestAccounts" });

      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      signer   = provider.getSigner();
      user     = await signer.getAddress();

      // chain check (no auto-switching)
      const chain = await readChainId();
      onCorrectChain = chain === CHAIN_ID_HEX;

      setStatus(`Connected: ${user.slice(0,6)}…${user.slice(-4)} • Chain: ${chain}`);

      if (onCorrectChain) {
        setBanner(false);
        setMintEnabled(true);
      } else {
        setMintEnabled(false);
        setBanner(true, "Switch your wallet to Base Sepolia (84532), then press Retry.");
        $("retry").style.display = "inline-block";
      }

    } catch (err) {
      console.error(err);
      setStatus(err?.error?.message || err?.data?.message || err.message || "Connection failed");
    }
  }

  async function retryChainCheck() {
    try {
      const chain = await readChainId();
      onCorrectChain = chain === CHAIN_ID_HEX;
      setStatus(`Connected: ${user ? user.slice(0,6)+"…"+user.slice(-4) : "—"} • Chain: ${chain}`);
      if (onCorrectChain) {
        setBanner(false);
        $("retry").style.display = "none";
        setMintEnabled(!!user);
      } else {
        setMintEnabled(false);
        setBanner(true, "Still not on Base Sepolia (84532). Switch in your wallet, then press Retry.");
      }
    } catch (err) {
      console.error(err);
      setStatus(err?.message || "Retry failed");
    }
  }

  // Listen for wallet changes and react
  function attachWalletListeners() {
    if (!window.ethereum) return;
    window.ethereum.on?.("accountsChanged", async (accounts) => {
      user = (accounts && accounts[0]) ? accounts[0] : undefined;
      setStatus(user ? `Account: ${user.slice(0,6)}…${user.slice(-4)}` : "Disconnected");
      setMintEnabled(false);
    });
    window.ethereum.on?.("chainChanged", async (_chainId) => {
      onCorrectChain = (_chainId || "").toLowerCase() === CHAIN_ID_HEX;
      if (onCorrectChain) {
        setBanner(false);
        $("retry").style.display = "none";
        setMintEnabled(!!user);
      } else {
        setMintEnabled(false);
        setBanner(true, "Switch your wallet to Base Sepolia (84532), then press Retry.");
        $("retry").style.display = "inline-block";
      }
    });
  }

  // ---- Log scan with 10k-cap-safe windows ----
  async function getSigneeNumberViaLogs(addr) {
    const iface  = new ethers.utils.Interface(DECLARATION_ABI);
    const topic0 = iface.getEventTopic("DeclarationSigned");
    const latest = await provider.getBlockNumber();

    const STEP = 8000; // under common 10k cap
    let from = DECLARATION_DEPLOY_BLOCK > 0 ? DECLARATION_DEPLOY_BLOCK : Math.max(0, latest - STEP * 4);
    let to   = Math.min(latest, from + STEP);

    while (from <= latest) {
      try {
        const logs = await provider.getLogs({
          address: DECLARATION_ADDR,
          fromBlock: from,
          toBlock: to,
          topics: [topic0, ethers.utils.hexZeroPad(addr, 32)]
        });

        if (logs.length) {
          const parsed = iface.parseLog(logs[logs.length - 1]);
          return parsed.args.signatureNumber.toNumber();
        }
      } catch (e) {
        // If RPC still complains about range, shrink once and retry this span
        if (/range/i.test(e.message || "")) {
          const half = Math.max(2000, Math.floor((to - from) / 2));
          if (half < (to - from)) { to = from + half; continue; }
        }
        throw e;
      }

      from = to + 1;
      to   = Math.min(latest, from + STEP);
    }

    throw new Error("No DeclarationSigned event found for this address");
  }

  async function handleMint() {
    try {
      if (!provider || !signer || !user) { setStatus("Connect your wallet first."); return; }
      if (!onCorrectChain) { setStatus("Switch your wallet to Base Sepolia (84532) and press Retry."); return; }

      $("mint").disabled = true;
      setStatus("Preparing…");

      const declaration = new ethers.Contract(DECLARATION_ADDR, DECLARATION_ABI, signer);
      const sbt         = new ethers.Contract(SBT_ADDR, SBT_ABI, signer);

      // If already minted, just load
      try {
        const existingId = await sbt.tokenIdOf(user);
        if (existingId && !ethers.BigNumber.from(existingId).isZero()) {
          setStatus("You already minted. Loading your NFT…");
          await showNft(sbt, existingId);
          return;
        }
      } catch {/* ignore and continue */}

      // If not signed, sign first
      const hasSigned = await declaration.hasSigned(user);
      if (!hasSigned) {
        const chosen = $("name").value.trim();
        if (!/^[a-z0-9-]{1,14}$/.test(chosen)) {
          throw new Error("Name must be 1–14 chars, lowercase a–z, 0–9 or '-'");
        }
        setStatus("Signing the Declaration…");
        const tx = await declaration.cosignDeclaration(chosen);
        const rc = await tx.wait();
        setStatus(`Signed. <a class="link" href="${EXPLORER}/tx/${rc.transactionHash}" target="_blank" rel="noopener">View on BaseScan</a>`);
      }

      // Mint
      setStatus("Looking up your signee number…");
      const signeeNumber = await getSigneeNumberViaLogs(user);

      setStatus("Minting your soulbound NFT…");
      const tx2 = await sbt.claimWithSignee(signeeNumber);
      const rc2 = await tx2.wait();
      setStatus(`Minted. <a class="link" href="${EXPLORER}/tx/${rc2.transactionHash}" target="_blank" rel="noopener">View on BaseScan</a>`);

      const tokenId = await sbt.tokenIdOf(user);
      await showNft(sbt, tokenId);

    } catch (err) {
      console.error(err);
      setStatus(err?.error?.message || err?.data?.message || err.message || "Something went wrong");
      $("mint").disabled = false;
    }
  }

  async function showNft(sbt, tokenId) {
    const uri  = await sbt.tokenURI(tokenId);
    const json = atob(uri.split(",")[1]);
    const data = JSON.parse(json);

    $("nftTitle").textContent = data.name;
    $("nftImg").src = data.image;

    const opensea = `https://testnets.opensea.io/assets/base-sepolia/${SBT_ADDR}/${tokenId}`;
    $("opensea").href = opensea;

    const shareText = encodeURIComponent("I co-signed THE DECLARATION OF THE DAVES. The Banksy stays on the wall.");
    $("xshare").href  = `https://twitter.com/intent/tweet?text=${shareText}&url=${encodeURIComponent(EXPLORER)}`;
    $("fcshare").href = `https://warpcast.com/~/compose?text=${shareText}`;

    $("result").style.display = "block";
    $("mint").disabled = true;
  }

  window.addEventListener("DOMContentLoaded", () => {
    $("connect").onclick = connect;
    $("retry").onclick   = retryChainCheck;
    $("mint").onclick    = handleMint;
    $("name").addEventListener("input", updatePreview);
    updatePreview();
    attachWalletListeners();
  });
</script>
</head>
<body>
  <div class="wrap">
    <h1>i_am_dave — The Banksy Stays on the Wall (Base Sepolia)</h1>

    <div class="card">
      <div class="row" style="gap:8px;">
        <button class="btn" id="connect">Connect wallet</button>
        <button class="btn" id="retry" style="display:none;">Retry</button>
      </div>

      <div id="banner" class="banner"></div>

      <div class="row" style="margin-top:12px;">
        <input id="name" class="input" maxlength="14" placeholder="yourname"
               pattern="[a-z0-9\-]{1,14}" title="lowercase letters, numbers, hyphen only" />
        <button class="btn" id="mint" disabled>Mint</button>
      </div>

      <div class="hint">Format: i_am_(yourName)_dave • 1–14 chars • a–z, 0–9, -</div>

      <div class="nft" style="margin-top:12px;">
        <div id="previewText" style="font-size:24px; color:#F3F3F3;"></div>
      </div>

      <div id="status" class="hint" style="margin-top:10px;"></div>
    </div>

    <div id="result" class="card" style="display:none;">
      <div class="nft"><img id="nftImg" alt="Your NFT" style="max-width:90%; max-height:90%;"/></div>
      <div id="nftTitle" style="margin-top:8px;"></div>
      <div class="share" style="margin-top:12px;">
        <a id="opensea" class="link" target="_blank" rel="noopener">OpenSea (may not load on testnet)</a>
        <a id="xshare" class="link" target="_blank" rel="noopener">Share on X</a>
        <a id="fcshare" class="link" target="_blank" rel="noopener">Share on Farcaster</a>
      </div>
    </div>

    <div class="hint">Declaration: 0xB0731E7ea189c169640Fd890E5dcE9811040D0eA • SBT: 0xe255130A9e2277640d3DfB045075a38d63a34D06 • Base Sepolia</div>
  </div>
</body>
</html>
