<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>i_am_dave — Mint (Base Sepolia)</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --bg:#2B2B2B; --fg:#F3F3F3; }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:"JetBrains Mono", monospace; }
  .wrap { max-width: 560px; margin: 0 auto; padding: 24px; display:flex; flex-direction:column; gap:16px; }
  h1 { font-size:18px; margin:0 0 6px; }
  .card { background:#1f1f1f; border:1px solid #3a3a3a; border-radius:12px; padding:16px; }
  .row { display:flex; gap:8px; align-items:center; }
  .input { flex:1; background:#151515; border:1px solid #3a3a3a; color:var(--fg); border-radius:10px; padding:12px 14px; font-family:inherit; font-size:16px; }
  .btn { background:#0c0c0c; border:1px solid #3a3a3a; color:var(--fg); border-radius:10px; padding:12px 16px; font-size:16px; cursor:pointer; white-space:nowrap; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }
  .hint { font-size:12px; opacity:.85; }
  .nft { width:100%; aspect-ratio:1/1; background:#2B2B2B; border:1px solid #3a3a3a; border-radius:12px; display:grid; place-items:center; }
  .share { display:flex; gap:10px; flex-wrap:wrap; }
  a.link { color: var(--fg); text-decoration: underline; }
</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
  // ---- CONFIG (Base Sepolia) ----
  const CHAIN_ID_HEX = "0x14A34"; // 84532
  const EXPLORER = "https://sepolia.basescan.org";
  const DECLARATION_ADDR = "0xB0731E7ea189c169640Fd890E5dcE9811040D0eA";
  const SBT_ADDR          = "0xe255130A9e2277640d3DfB045075a38d63a34D06";

  const DECLARATION_ABI = [
    "function hasSigned(address) view returns (bool)",
    "function signatureByAddress(address) view returns (string)",
    "function getSignature(uint256) view returns (string,address,uint256,uint256)",
    "function cosignDeclaration(string chosenName)",
    "event DeclarationSigned(address indexed signatory, string daveName, uint256 signatureNumber, uint256 blockNumber)"
  ];
  const SBT_ABI = [
    "function claimWithSignee(uint256 signeeNumber)",
    "function tokenIdOf(address) view returns (uint256)",
    "function tokenURI(uint256) view returns (string)"
  ];

  let provider, signer, user;

  const $ = (id) => document.getElementById(id);

  function updatePreview() {
    const v = $('name').value.trim();
    $('previewText').textContent = v ? `i_am_${v}_dave` : "i_am_(yourName)_dave";
  }

  async function requestAccounts() {
    return window.ethereum.request({ method:"eth_requestAccounts" });
  }

  async function ensureBaseSepolia() {
    const chainId = await window.ethereum.request({ method:"eth_chainId" });
    if (chainId.toLowerCase() === CHAIN_ID_HEX.toLowerCase()) return;

    // Try switch
    try {
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: CHAIN_ID_HEX }]
      });
      return;
    } catch (e) {
      // If chain not added, try add
      if (e && (e.code === 4902 || /not added/i.test(e.message || ""))) {
        try {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [{
              chainId: CHAIN_ID_HEX,
              chainName: "Base Sepolia",
              nativeCurrency: { name:"Ether", symbol:"ETH", decimals:18 },
              rpcUrls: ["https://sepolia.base.org"],
              blockExplorerUrls: [EXPLORER]
            }]
          });
          return;
        } catch (e2) {
          // fall through to manual message
        }
      }
      // If switch method not supported or user rejected, show manual instructions
      throw new Error("Please switch your wallet network to Base Sepolia (chainId 84532), then click Retry.");
    }
  }

  async function connect() {
    try {
      if (!window.ethereum) {
        $('status').innerHTML = 'No wallet detected. Install <a class="link" href="https://metamask.io" target="_blank">MetaMask</a> or open with a wallet that supports WalletConnect.';
        return;
      }

      await requestAccounts(); // triggers wallet connect
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      signer   = provider.getSigner();
      user     = await signer.getAddress();

      try {
        await ensureBaseSepolia();
      } catch (e) {
        $('status').textContent = e.message;
        $('retry').style.display = "inline-block";
        return;
      }

      $('status').textContent = `Connected: ${user.slice(0,6)}…${user.slice(-4)} on Base Sepolia`;
      $('connect').disabled = true;
      $('mint').disabled = false;
      $('retry').style.display = "none";

    } catch (err) {
      console.error(err);
      $('status').textContent = err?.error?.message || err?.data?.message || err.message || "Connection failed";
    }
  }

  // Event log lookup for signee number
  async function getSigneeNumberViaLogs(addr) {
    const iface  = new ethers.utils.Interface(DECLARATION_ABI);
    const topic0 = iface.getEventTopic("DeclarationSigned");
    const filter = {
      address: DECLARATION_ADDR,
      fromBlock: 0,
      toBlock: "latest",
      topics: [topic0, ethers.utils.hexZeroPad(addr, 32)]
    };
    const logs = await provider.getLogs(filter);
    if (!logs.length) throw new Error("No signature found for this address");
    const parsed = iface.parseLog(logs[logs.length - 1]);
    return parsed.args.signatureNumber.toNumber();
  }

  async function handleMint() {
    try {
      $('mint').disabled = true;
      $('status').textContent = "Preparing…";

      const declaration = new ethers.Contract(DECLARATION_ADDR, DECLARATION_ABI, signer);
      const sbt         = new ethers.Contract(SBT_ADDR, SBT_ABI, signer);

      // If not signed, sign
      const hasSigned = await declaration.hasSigned(user);
      if (!hasSigned) {
        const chosen = $('name').value.trim();
        if (!/^[a-z0-9-]{1,14}$/.test(chosen)) {
          throw new Error("Name must be 1–14 chars, lowercase a–z, 0–9 or '-'");
        }
        $('status').textContent = "Signing the Declaration…";
        const tx = await declaration.cosignDeclaration(chosen);
        const rc = await tx.wait();
        $('status').innerHTML = `Signed. <a class="link" href="${EXPLORER}/tx/${rc.transactionHash}" target="_blank">View on BaseScan</a>`;
      }

      // Mint
      $('status').textContent = "Fetching your signee number…";
      const signeeNumber = await getSigneeNumberViaLogs(user);

      $('status').textContent = "Minting your soulbound NFT…";
      const tx2 = await sbt.claimWithSignee(signeeNumber);
      const rc2 = await tx2.wait();
      $('status').innerHTML = `Minted. <a class="link" href="${EXPLORER}/tx/${rc2.transactionHash}" target="_blank">View on BaseScan</a>`;

      const tokenId = await sbt.tokenIdOf(user);
      await showNft(sbt, tokenId);

    } catch (err) {
      console.error(err);
      $('status').textContent = err?.error?.message || err?.data?.message || err.message || "Something went wrong";
      $('mint').disabled = false;
    }
  }

  async function showNft(sbt, tokenId) {
    const uri  = await sbt.tokenURI(tokenId);
    const json = atob(uri.split(",")[1]);
    const data = JSON.parse(json);

    $('nftTitle').textContent = data.name;
    $('nftImg').src = data.image;

    const opensea = `https://testnets.opensea.io/assets/base-sepolia/${SBT_ADDR}/${tokenId}`;
    $('opensea').href = opensea;

    const shareText = encodeURIComponent("I co-signed THE DECLARATION OF THE DAVES. The Banksy stays on the wall.");
    $('xshare').href  = `https://twitter.com/intent/tweet?text=${shareText}&url=${encodeURIComponent(opensea)}`;
    $('fcshare').href = `https://warpcast.com/~/compose?text=${shareText}&embeds[]=${encodeURIComponent(opensea)}`;

    $('result').style.display = "block";
    $('mint').disabled = true;
  }

  window.addEventListener("DOMContentLoaded", () => {
    $('connect').onclick = connect;
    $('retry').onclick   = connect;
    $('mint').onclick    = handleMint;
    $('name').addEventListener("input", updatePreview);
    updatePreview();
  });
</script>
</head>
<body>
  <div class="wrap">
    <h1>i_am_dave — The Banksy Stays on the Wall (Base Sepolia)</h1>

    <div class="card">
      <div class="row" style="gap:8px;">
        <button class="btn" id="connect">Connect wallet</button>
        <button class="btn" id="retry" style="display:none;">Retry</button>
      </div>
      <div class="row" style="margin-top:12px;">
        <input id="name" class="input" maxlength="14" placeholder="yourname"
               pattern="[a-z0-9\-]{1,14}" title="lowercase letters, numbers, hyphen only" />
        <button class="btn" id="mint" disabled>Mint</button>
      </div>
      <div class="hint">Format: i_am_(yourName)_dave • 1–14 chars • a–z, 0–9, -</div>
      <div class="nft" style="margin-top:12px;">
        <div id="previewText" style="font-size:24px; color:#F3F3F3;"></div>
      </div>
      <div id="status" class="hint" style="margin-top:10px;"></div>
    </div>

    <div id="result" class="card" style="display:none;">
      <div class="nft"><img id="nftImg" alt="Your NFT" style="max-width:90%; max-height:90%;"/></div>
      <div id="nftTitle" style="margin-top:8px;"></div>
      <div class="share" style="margin-top:12px;">
        <a id="opensea" class="link" target="_blank" rel="noopener">OpenSea (may not load on testnet)</a>
        <a id="xshare" class="link" target="_blank" rel="noopener">Share on X</a>
        <a id="fcshare" class="link" target="_blank" rel="noopener">Share on Farcaster</a>
      </div>
    </div>

    <div class="hint">Declaration: 0xB0731E7ea189c169640Fd890E5dcE9811040D0eA • SBT: 0xe255130A9e2277640d3DfB045075a38d63a34D06 • Base Sepolia</div>
  </div>
</body>
</html>
