<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Declaration of the Daves - Sign the Contract</title>
    
    <!-- Allow embedding in iframes -->
    <meta http-equiv="X-Frame-Options" content="ALLOWALL">
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0d1117;
            color: #c9d1d9;
            font-family: 'JetBrains Mono', monospace;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .widget-container {
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Main contract container - square format for desktop */
        .contract-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            width: 100%;
            aspect-ratio: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Collapsed state for mobile after signing */
        .contract-container.collapsed {
            aspect-ratio: unset;
            height: auto;
        }
        
        .contract-header {
            background: #0d1117;
            border-bottom: 1px solid #30363d;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-icon {
            color: #7ee787;
        }
        
        .filename {
            color: #f0f6fc;
            font-size: 14px;
        }
        
        .network-badge {
            margin-left: auto;
            background: #1f6feb;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .code-editor {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            padding: 40px 0;
        }
        
        /* Hide code editor when collapsed */
        .contract-container.collapsed .code-editor {
            display: none;
        }
        
        .line-numbers {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            text-align: right;
            color: #484f58;
            font-size: 12px;
            line-height: 20px;
            user-select: none;
        }
        
        .code-content {
            margin-left: 70px;
            margin-right: 40px;
            font-size: 12px;
            line-height: 20px;
            width: calc(100% - 110px);
        }
        
        /* Syntax highlighting */
        .comment {
            color: #8b949e;
            font-style: italic;
        }
        
        .keyword {
            color: #ff7b72;
        }
        
        .function-name {
            color: #d2a8ff;
        }
        
        .type {
            color: #79c0ff;
        }
        
        .string {
            color: #a5d6ff;
        }
        
        .parameter {
            color: #ffa657;
        }
        
        .address {
            color: #7ee787;
            font-size: 12px;
            word-break: break-all;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .number {
            color: #79c0ff;
        }
        
        /* Input styling */
        .input-line {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 8px 0;
            display: inline-flex;
            align-items: center;
            transition: border-color 0.2s;
            white-space: nowrap;
        }
        
        .input-line:hover {
            border-color: #58a6ff;
        }
        
        .input-line.focused {
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        .input-line.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .input-prefix, .input-suffix {
            color: #a5d6ff;
            font-size: 12px;
        }
        
        .name-input {
            background: none;
            border: none;
            color: #a5d6ff;
            font-family: inherit;
            font-size: 12px;
            outline: none;
            width: 140px;
            margin: 0 4px;
        }
        
        /* Mobile input styling */
        .mobile-input-line {
            display: none;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            width: 100%;
        }
        
        .mobile-input {
            background: none;
            border: none;
            color: #a5d6ff;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            width: 100%;
        }
        
        /* Preview section */
        .preview-comment {
            margin-top: 16px;
            padding: 8px;
            background: #0d1117;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .preview-comment .comment {
            font-size: 12px;
        }
        
        .preview-comment .string {
            font-size: 12px;
        }
        
        /* Action section */
        .action-section {
            background: #0d1117;
            border-top: 1px solid #30363d;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* Hide action section when collapsed except for button */
        .contract-container.collapsed .action-section {
            border-top: none;
            padding: 12px 20px;
        }
        
        .contract-info {
            font-size: 12px;
        }
        
        .contract-container.collapsed .contract-info {
            display: none;
        }
        
        .contract-label {
            color: #8b949e;
            margin-bottom: 4px;
        }
        
        .contract-address-link {
            color: #7ee787;
            text-decoration: none;
            transition: opacity 0.2s;
        }
        
        .contract-address-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
        
        .execute-button {
            background: #f78166;
            color: #0d1117;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .execute-button:hover:not(:disabled) {
            background: #ff8c73;
            transform: translateY(-1px);
        }
        
        .execute-button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .execute-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* WalletConnect Modal Styles */
        .wallet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .wallet-modal.show {
            display: flex;
        }
        
        .wallet-modal-content {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .wallet-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .wallet-modal-title {
            color: #f0f6fc;
            font-size: 18px;
            font-weight: 600;
        }
        
        .wallet-modal-close {
            background: none;
            border: none;
            color: #8b949e;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .wallet-modal-close:hover {
            color: #c9d1d9;
        }
        
        .wallet-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .wallet-option {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .wallet-option:hover {
            border-color: #58a6ff;
            transform: translateY(-1px);
        }
        
        .wallet-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .wallet-name {
            color: #c9d1d9;
            font-size: 14px;
            font-weight: 500;
        }
        
        .wallet-description {
            color: #8b949e;
            font-size: 12px;
            margin-top: 2px;
        }
        
        /* QR Code container */
        .qr-container {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: #0d1117;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .qr-container.show {
            display: flex;
        }
        
        .qr-code {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .qr-instructions {
            color: #8b949e;
            font-size: 12px;
            text-align: center;
        }
        
        /* Connected status */
        .wallet-status {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            color: #7ee787;
            display: none;
            align-items: center;
            gap: 6px;
        }
        
        .wallet-status.connected {
            display: flex;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #7ee787;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Error state */
        .error-message {
            background: #f85149;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin: 8px 0;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* NFT Preview - Square format */
        .nft-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            width: 100%;
            aspect-ratio: 1;
            margin: 40px auto 20px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .nft-container.show {
            display: flex;
        }
        
        .nft-code-editor {
            position: relative;
            width: 100%;
            padding: 40px 0;
        }
        
        .nft-line-numbers {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            text-align: right;
            color: #484f58;
            font-size: 12px;
            line-height: 20px;
            user-select: none;
        }
        
        .nft-code-content {
            margin-left: 70px;
            margin-right: 40px;
            font-size: 12px;
            line-height: 20px;
        }
        
        /* Mint button */
        .mint-button-container {
            text-align: center;
            margin-bottom: 40px;
            display: none;
        }
        
        .mint-button-container.show {
            display: block;
        }
        
        .mint-button {
            background: #f78166;
            color: #0d1117;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mint-button:hover:not(:disabled) {
            background: #ff8c73;
            transform: translateY(-1px);
        }
        
        .mint-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #0d1117;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Success message */
        .success-message {
            background: #238636;
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }
        
        .success-message.show {
            display: block;
        }
        
        .success-message a {
            color: #7ee787;
            text-decoration: none;
        }
        
        .success-message a:hover {
            text-decoration: underline;
        }
        
        /* Mobile specific styles */
        @media (max-width: 600px) {
            body {
                padding: 0;
                align-items: flex-start;
            }
            
            .widget-container {
                max-width: 100%;
                padding: 20px;
            }
            
            /* Top frame - remove square constraint on mobile */
            .contract-container {
                aspect-ratio: unset;
                height: auto;
                border-radius: 6px;
            }
            
            /* Keep header the same */
            .contract-header {
                padding: 10px 16px;
            }
            
            .filename {
                font-size: 13px;
            }
            
            .network-badge {
                font-size: 11px;
                padding: 3px 10px;
            }
            
            /* Adjust code editor for mobile */
            .code-editor {
                padding: 30px 0;
                align-items: flex-start;
            }
            
            .line-numbers {
                position: static;
                transform: none;
                margin-left: 16px;
                margin-top: 0;
            }
            
            .code-content {
                margin-left: 60px;
                margin-right: 16px;
                width: calc(100% - 76px);
            }
            
            /* Hide desktop input, show mobile input */
            .input-line {
                display: none;
            }
            
            .mobile-input-line {
                display: block;
                margin: 12px 0;
            }
            
            .mobile-input-line.focused {
                border-color: #58a6ff;
                box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
            }
            
            .mobile-input-line.disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            /* Action section adjustments */
            .action-section {
                padding: 16px;
                flex-direction: column;
                gap: 12px;
            }
            
            .contract-info {
                width: 100%;
                text-align: center;
            }
            
            .execute-button {
                width: 100%;
                font-size: 13px;
                padding: 12px 20px;
            }
            
            /* NFT Preview - smaller but still square */
            .nft-container {
                margin: 20px auto 16px;
                aspect-ratio: 1;
            }
            
            /* Scale down NFT content */
            .nft-code-editor {
                padding: 20px 0;
            }
            
            .nft-line-numbers {
                left: 12px;
                font-size: 9px;
                line-height: 14px;
                width: 20px;
            }
            
            .nft-code-content {
                margin-left: 40px;
                margin-right: 12px;
                font-size: 9px;
                line-height: 14px;
            }
            
            .nft-code-content .comment {
                font-size: 9px;
            }
            
            .nft-code-content .address {
                font-size: 9px;
            }
            
            /* Mint button adjustments */
            .mint-button-container {
                margin-bottom: 20px;
            }
            
            .mint-button {
                width: 100%;
                font-size: 13px;
                padding: 12px 20px;
            }
            
            /* Wallet status position */
            .wallet-status {
                position: static;
                margin: 10px 16px;
                font-size: 11px;
            }
            
            /* Error message */
            .error-message {
                font-size: 11px;
                margin: 8px 16px;
            }
            
            /* Success message */
            .success-message {
                font-size: 11px;
                margin: 16px 0;
            }
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <!-- Main Widget -->
        <div class="contract-container" id="contractContainer">
            <!-- Header -->
            <div class="contract-header">
                <span class="file-icon">üìÑ</span>
                <span class="filename">DeclarationOfTheDaves.sol</span>
                <span class="network-badge">Base Mainnet</span>
            </div>
            
            <!-- Wallet Status -->
            <div class="wallet-status" id="walletStatus">
                <span class="status-dot"></span>
                <span id="walletAddress">Connected</span>
            </div>
            
            <!-- Code Editor -->
            <div class="code-editor">
                <div class="line-numbers">
                    <div>1</div>
                    <div>2</div>
                    <div>3</div>
                    <div>4</div>
                    <div>5</div>
                    <div>6</div>
                    <div>7</div>
                    <div>8</div>
                    <div>9</div>
                    <div>10</div>
                    <div>11</div>
                    <div>12</div>
                    <div>13</div>
                    <div>14</div>
                    <div>15</div>
                    <div>16</div>
                    <div>17</div>
                </div>
                
                <div class="code-content">
                    <div><span class="keyword">pragma</span> <span class="type">solidity</span> ^0.8.19;</div>
                    <br>
                    <div class="comment">/**</div>
                    <div class="comment"> * @title THE DECLARATION OF THE DAVES 001</div>
                    <div class="comment"> * @notice THE BANKSY STAYS ON THE WALL</div>
                    <div class="comment"> * @dev This contract is the art. Immutable. Permanent. Public.</div>
                    <div class="comment"> * @dev Co-sign the declaration by calling this function</div>
                    <div class="comment"> */</div>
                    <br>
                    <div><span class="keyword">function</span> <span class="function-name">cosignDeclaration</span>(<span class="type">string</span> <span class="type">memory</span> <span class="parameter">chosenName</span>) <span class="keyword">public</span> {</div>
                    <div style="margin-left: 20px;">
                        <div class="comment">// Enter your chosen name (lowercase, max 14 chars)</div>
                        <!-- Desktop input -->
                        <div class="input-line" id="inputLine" onclick="focusInput()">
                            <span class="input-prefix">require(chosenName == "</span>
                            <input type="text" class="name-input" id="nameInput" placeholder="your_name" maxlength="14" autocomplete="off" spellcheck="false">
                            <span class="input-suffix">", "Enter name");</span>
                        </div>
                        <!-- Mobile input -->
                        <div class="mobile-input-line" id="mobileInputLine">
                            <input type="text" class="mobile-input" id="mobileNameInput" placeholder="Enter your name (lowercase, max 14 chars)" maxlength="14" autocomplete="off" spellcheck="false">
                        </div>
                        <div class="preview-comment">
                            <span class="comment">// Your signature will be: </span>
                            <span class="string" id="preview">i_am_your_name_dave</span>
                        </div>
                    </div>
                    <div>}</div>
                    
                    <div class="error-message" id="errorMsg">
                        ‚ö†Ô∏è <span id="errorText">Name can only contain lowercase letters, numbers, and hyphens</span>
                    </div>
                </div>
            </div>
            
            <!-- Action Section -->
            <div class="action-section">
                <div class="contract-info">
                    <div class="contract-label">Contract</div>
                    <a href="https://basescan.org/address/0xB0731E7ea189c169640Fd890E5dcE9811040D0eA#code" 
                       target="_blank" 
                       rel="noopener noreferrer" 
                       class="contract-address-link">
                        0xB0731E7ea189c169640Fd890E5dcE9811040D0eA
                    </a>
                </div>
                <button class="execute-button" id="executeButton">CONNECT WALLET</button>
            </div>
        </div>
        
        <!-- Wallet Selection Modal -->
        <div class="wallet-modal" id="walletModal">
            <div class="wallet-modal-content">
                <div class="wallet-modal-header">
                    <h3 class="wallet-modal-title">Connect Wallet</h3>
                    <button class="wallet-modal-close" id="closeModal">&times;</button>
                </div>
                
                <div class="wallet-options" id="walletOptions">
                    <!-- MetaMask option (injected) -->
                    <div class="wallet-option" id="metamaskOption" style="display: none;">
                        <div class="wallet-icon" style="background: #f6851b;">ü¶ä</div>
                        <div>
                            <div class="wallet-name">MetaMask</div>
                            <div class="wallet-description">Connect using browser extension</div>
                        </div>
                    </div>
                    
                    <!-- WalletConnect option -->
                    <div class="wallet-option" id="walletConnectOption">
                        <div class="wallet-icon" style="background: #3b99fc;">üîó</div>
                        <div>
                            <div class="wallet-name">WalletConnect</div>
                            <div class="wallet-description">Scan with wallet to connect</div>
                        </div>
                    </div>
                    
                    <!-- Coinbase Wallet option -->
                    <div class="wallet-option" id="coinbaseOption">
                        <div class="wallet-icon" style="background: #0052ff;">üí∞</div>
                        <div>
                            <div class="wallet-name">Coinbase Wallet</div>
                            <div class="wallet-description">Connect with Coinbase Wallet</div>
                        </div>
                    </div>
                </div>
                
                <!-- QR Code Container (hidden by default) -->
                <div class="qr-container" id="qrContainer">
                    <div class="qr-code" id="qrCode">
                        <!-- QR code will be inserted here -->
                    </div>
                    <div class="qr-instructions">
                        Scan with your wallet app to connect
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NFT Preview (hidden until transaction complete or already signed) -->
        <div class="nft-container" id="nftPreview">
            <div class="nft-code-editor">
                <div class="nft-line-numbers">
                    <div>1</div>
                    <div>2</div>
                    <div>3</div>
                    <div>4</div>
                    <div>5</div>
                    <div>6</div>
                    <div>7</div>
                    <div>8</div>
                    <div>9</div>
                    <div>10</div>
                    <div>11</div>
                    <div>12</div>
                    <div>13</div>
                    <div>14</div>
                </div>
                
                <div class="nft-code-content" id="nftContent">
                    <!-- NFT content will be populated dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Mint Button (hidden until transaction complete or already signed) -->
        <div class="mint-button-container" id="mintButtonContainer">
            <button class="mint-button" id="mintButton">MINT AS NFT (0.001439 ETH)</button>
        </div>
        
        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            <div id="successText">NFT Minted Successfully!</div>
            <div style="margin-top: 8px;">
                <a id="openSeaLink" href="#" target="_blank" rel="noopener noreferrer">View on OpenSea ‚Üí</a>
            </div>
        </div>
    </div>

    <script>
        // Load libraries
        function loadScript(src, callback) {
            const script = document.createElement('script');
            script.src = src;
            script.onload = callback;
            script.onerror = function() {
                console.error('Failed to load script:', src);
                callback(new Error('Script load failed'));
            };
            document.head.appendChild(script);
        }
        
        // Load ethers and WalletConnect
        function loadLibraries(callback) {
            // Load ethers first
            loadScript('https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js', function(err) {
                if (err) {
                    loadScript('https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js', function(err2) {
                        if (err2) {
                            showError('Failed to load Web3 library. Please refresh the page.');
                            return;
                        }
                        console.log('[Dave Contract] Ethers loaded from backup CDN');
                        
                        // Load WalletConnect
                        loadScript('https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js', function() {
                            console.log('[Dave Contract] WalletConnect loaded');
                            callback();
                        });
                    });
                } else {
                    console.log('[Dave Contract] Ethers loaded successfully');
                    
                    // Load WalletConnect
                    loadScript('https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js', function() {
                        console.log('[Dave Contract] WalletConnect loaded');
                        callback();
                    });
                }
            });
        }
        
        // Initialize widget after libraries load
        loadLibraries(function() {
            console.log('[Dave Contract] All libraries loaded');
            
            // Contract details
            const CONTRACT_ADDRESS = '0xB0731E7ea189c169640Fd890E5dcE9811040D0eA';
            
            // TODO: REPLACE THIS WITH YOUR DEPLOYED NFT CONTRACT ADDRESS
            const NFT_CONTRACT_ADDRESS = 'YOUR_NFT_CONTRACT_ADDRESS_HERE';
            
            const BASE_CHAIN_ID = '0x2105'; // 8453 in hex
            const BASE_CHAIN_ID_DEC = 8453;
            
            // CORRECTED CONTRACT ABI - Matching actual deployed contract
            const CONTRACT_ABI = [
                "function cosignDeclaration(string memory chosenName) public",
                "function hasSigned(address) public view returns (bool)",
                "function signatureByAddress(address) public view returns (string)",
                "function allSignatures(uint256) public view returns (tuple(string daveName, address signatory, uint256 timestamp, uint256 blockNumber))",
                "function totalSignatures() public view returns (uint256)",
                "function nameExists(string) public view returns (bool)",
                "function isAllowlistActive() public view returns (bool)",
                "function timeUntilPublic() public view returns (uint256)",
                "function getSignature(uint256) public view returns (string daveName, address signatory, uint256 timestamp, uint256 blockNumber)",
                "event DeclarationSigned(address indexed signatory, string daveName, uint256 signatureNumber, uint256 blockNumber)"
            ];
            
            const NFT_CONTRACT_ABI = [
                "function mint(bytes32 _originalTxHash, uint256 _signatureNumber, uint256 _blockNumber) public payable",
                "function hasMinted(address) public view returns (bool)",
                "function addressToTokenId(address) public view returns (uint256)",
                "function MINT_PRICE() public view returns (uint256)"
            ];
            
            // State
            let provider = null;
            let signer = null;
            let contract = null;
            let nftContract = null;
            let connected = false;
            let userAddress = null;
            let currentTxHash = null;
            let signatureData = null;
            let walletConnectProvider = null;
            
            // Elements
            const contractContainer = document.getElementById('contractContainer');
            const executeButton = document.getElementById('executeButton');
            const nameInput = document.getElementById('nameInput');
            const mobileNameInput = document.getElementById('mobileNameInput');
            const errorMsg = document.getElementById('errorMsg');
            const errorText = document.getElementById('errorText');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const preview = document.getElementById('preview');
            const inputLine = document.getElementById('inputLine');
            const mobileInputLine = document.getElementById('mobileInputLine');
            const nftPreview = document.getElementById('nftPreview');
            const nftContent = document.getElementById('nftContent');
            const mintButtonContainer = document.getElementById('mintButtonContainer');
            const mintButton = document.getElementById('mintButton');
            const successMessage = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            const openSeaLink = document.getElementById('openSeaLink');
            const walletModal = document.getElementById('walletModal');
            const closeModal = document.getElementById('closeModal');
            const metamaskOption = document.getElementById('metamaskOption');
            const walletConnectOption = document.getElementById('walletConnectOption');
            const coinbaseOption = document.getElementById('coinbaseOption');
            const qrContainer = document.getElementById('qrContainer');
            const qrCode = document.getElementById('qrCode');
            
            // Check if mobile
            const isMobile = window.innerWidth <= 600 || /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase());
            
            // Focus input helper
            window.focusInput = function() {
                if (!nameInput.disabled && !isMobile) {
                    nameInput.focus();
                }
            };
            
            // Sync desktop and mobile inputs
            function syncInputs(source, target) {
                target.value = source.value;
                const value = source.value.toLowerCase();
                
                if (value) {
                    preview.textContent = `i_am_${value}_dave`;
                } else {
                    preview.textContent = 'i_am_your_name_dave';
                }
                
                // Clear error on typing
                errorMsg.classList.remove('show');
            }
            
            // Desktop input handlers
            nameInput.addEventListener('focus', () => {
                inputLine.classList.add('focused');
            });
            
            nameInput.addEventListener('blur', () => {
                inputLine.classList.remove('focused');
            });
            
            nameInput.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                e.target.value = value;
                syncInputs(nameInput, mobileNameInput);
            });
            
            // Mobile input handlers
            mobileNameInput.addEventListener('focus', () => {
                mobileInputLine.classList.add('focused');
            });
            
            mobileNameInput.addEventListener('blur', () => {
                mobileInputLine.classList.remove('focused');
            });
            
            mobileNameInput.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                e.target.value = value;
                syncInputs(mobileNameInput, nameInput);
            });
            
            // Error handling
            function showError(message) {
                console.error('[Dave Contract] Error:', message);
                errorText.textContent = message;
                errorMsg.classList.add('show');
                setTimeout(() => {
                    errorMsg.classList.remove('show');
                }, 7000);
            }
            
            function clearMessages() {
                errorMsg.classList.remove('show');
            }
            
            // Modal handlers
            closeModal.addEventListener('click', () => {
                walletModal.classList.remove('show');
                qrContainer.classList.remove('show');
            });
            
            walletModal.addEventListener('click', (e) => {
                if (e.target === walletModal) {
                    walletModal.classList.remove('show');
                    qrContainer.classList.remove('show');
                }
            });
            
            // Show wallet modal
            function showWalletModal() {
                walletModal.classList.add('show');
                
                // Show MetaMask option if available
                if (window.ethereum && !isMobile) {
                    metamaskOption.style.display = 'flex';
                }
            }
            
            // Generate NFT preview content
            function generateNFTPreview(daveName, signatureNumber, blockNumber, txHash, signerAddr) {
                const shortName = daveName.replace('i_am_', '').replace('_dave', '');
                return `<div class="comment">/**</div>
<div class="comment"> * @title THE DECLARATION OF THE DAVES 001</div>
<div class="comment"> * Contract: 0xB0731E7ea189c169640Fd890E5dcE9811040D0eA</div>
<div class="comment"> * @notice THE BANKSY STAYS ON THE WALL</div>
<div class="comment"> * Signed by: <span class="number">${shortName}_dave</span></div>
<div class="comment"> */</div>
<br>
<div class="comment">// Signature Number: <span class="number">#${signatureNumber}</span></div>
<div class="comment">// Block Number: <span class="number">${blockNumber}</span></div>
<br>
<div class="comment">// Transaction Hash:</div>
<div class="address">${txHash}</div>
<br>
<div class="comment">// Signer Address:</div>
<div class="address">${signerAddr}</div>`;
            }
            
            // Get signature data for an address
            async function getSignatureData(address) {
                try {
                    console.log('[Dave Contract] Getting signature data for:', address);
                    
                    const hasSigned = await contract.hasSigned(address);
                    console.log('[Dave Contract] Has signed:', hasSigned);
                    
                    if (!hasSigned) {
                        return null;
                    }
                    
                    const daveName = await contract.signatureByAddress(address);
                    console.log('[Dave Contract] Dave name:', daveName);
                    
                    const totalSigs = await contract.totalSignatures();
                    console.log('[Dave Contract] Total signatures:', totalSigs.toString());
                    
                    for (let i = 0; i < totalSigs; i++) {
                        try {
                            const sig = await contract.allSignatures(i);
                            
                            let sigAddress;
                            let sigDaveName;
                            let sigTimestamp;
                            let sigBlockNumber;
                            
                            if (sig.signatory) {
                                sigAddress = sig.signatory;
                                sigDaveName = sig.daveName;
                                sigTimestamp = sig.timestamp;
                                sigBlockNumber = sig.blockNumber;
                            } else if (Array.isArray(sig)) {
                                sigDaveName = sig[0];
                                sigAddress = sig[1];
                                sigTimestamp = sig[2];
                                sigBlockNumber = sig[3];
                            }
                            
                            if (sigAddress && sigAddress.toLowerCase() === address.toLowerCase()) {
                                console.log('[Dave Contract] Found matching signature at index:', i);
                                return {
                                    daveName: sigDaveName || daveName,
                                    signatureNumber: i + 1,
                                    blockNumber: sigBlockNumber ? sigBlockNumber.toString() : 'Unknown',
                                    timestamp: sigTimestamp ? sigTimestamp.toString() : 'Unknown'
                                };
                            }
                        } catch (err) {
                            console.error(`[Dave Contract] Error reading signature ${i}:`, err);
                        }
                    }
                    
                    if (daveName) {
                        return {
                            daveName: daveName,
                            signatureNumber: 'Unknown',
                            blockNumber: 'Unknown',
                            timestamp: 'Unknown'
                        };
                    }
                    
                    return null;
                } catch (error) {
                    console.error('[Dave Contract] Error getting signature data:', error);
                    return null;
                }
            }
            
            // Check NFT minting status
            async function checkNFTStatus() {
                if (!nftContract || NFT_CONTRACT_ADDRESS === 'YOUR_NFT_CONTRACT_ADDRESS_HERE') {
                    return { canMint: true, hasMinted: false };
                }
                
                try {
                    const hasMinted = await nftContract.hasMinted(userAddress);
                    return { canMint: !hasMinted, hasMinted };
                } catch (error) {
                    console.error('[Dave Contract] Error checking NFT status:', error);
                    return { canMint: true, hasMinted: false };
                }
            }
            
            // Collapse top frame on mobile after signing
            function collapseTopFrame() {
                if (isMobile) {
                    contractContainer.classList.add('collapsed');
                }
            }
            
            // Show NFT preview for already-signed users
            async function showExistingSignature() {
                signatureData = await getSignatureData(userAddress);
                
                if (!signatureData) {
                    console.log('[Dave Contract] No signature data found for user');
                    return false;
                }
                
                console.log('[Dave Contract] Showing existing signature:', signatureData);
                
                nameInput.disabled = true;
                mobileNameInput.disabled = true;
                nameInput.value = '';
                mobileNameInput.value = '';
                inputLine.classList.add('disabled');
                mobileInputLine.classList.add('disabled');
                document.querySelector('.preview-comment .comment').textContent = '// ';
                preview.textContent = 'THE BANKSY STAYS ON THE WALL';
                executeButton.innerHTML = 'SIGNED';
                executeButton.disabled = true;
                
                collapseTopFrame();
                
                nftContent.innerHTML = generateNFTPreview(
                    signatureData.daveName,
                    signatureData.signatureNumber,
                    signatureData.blockNumber,
                    '0x... (retroactive mint - original tx not stored)',
                    userAddress
                );
                
                nftPreview.classList.add('show');
                
                const { canMint, hasMinted } = await checkNFTStatus();
                
                if (hasMinted && NFT_CONTRACT_ADDRESS !== 'YOUR_NFT_CONTRACT_ADDRESS_HERE') {
                    const tokenId = await nftContract.addressToTokenId(userAddress);
                    successText.textContent = `You already minted NFT #${tokenId}`;
                    openSeaLink.href = `https://opensea.io/assets/base/${NFT_CONTRACT_ADDRESS}/${tokenId}`;
                    successMessage.classList.add('show');
                } else if (canMint) {
                    mintButtonContainer.classList.add('show');
                    mintButton.title = 'Retroactive mint - will be marked as pre-NFT signature';
                }
                
                setTimeout(() => {
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'resize',
                            height: document.body.scrollHeight
                        }, '*');
                    }
                }, 100);
                
                return true;
            }
            
            // Connect with injected provider (MetaMask)
            async function connectInjected() {
                if (!window.ethereum) {
                    showError('MetaMask not detected');
                    return;
                }
                
                walletModal.classList.remove('show');
                await connectWallet(window.ethereum);
            }
            
            // Connect with WalletConnect
            async function connectWalletConnect() {
                try {
                    console.log('[Dave Contract] Initializing WalletConnect...');
                    
                    // Show QR code container
                    qrContainer.classList.add('show');
                    qrCode.innerHTML = 'Loading...';
                    
                    // Initialize WalletConnect Provider
                    const WalletConnectProvider = window.WalletConnectProvider.default;
                    walletConnectProvider = new WalletConnectProvider({
                        rpc: {
                            8453: 'https://mainnet.base.org'
                        },
                        chainId: BASE_CHAIN_ID_DEC,
                        qrcodeModal: {
                            open: (uri, cb) => {
                                console.log('[Dave Contract] WalletConnect URI:', uri);
                                // Generate QR code
                                qrCode.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(uri)}" alt="QR Code" />`;
                            },
                            close: () => {
                                qrContainer.classList.remove('show');
                            }
                        }
                    });
                    
                    // Enable session (triggers QR Code modal)
                    await walletConnectProvider.enable();
                    console.log('[Dave Contract] WalletConnect connected');
                    
                    walletModal.classList.remove('show');
                    qrContainer.classList.remove('show');
                    
                    // Connect with the WalletConnect provider
                    await connectWallet(walletConnectProvider);
                    
                } catch (error) {
                    console.error('[Dave Contract] WalletConnect error:', error);
                    qrContainer.classList.remove('show');
                    if (error.message?.includes('User closed modal')) {
                        showError('Connection cancelled');
                    } else {
                        showError('WalletConnect connection failed');
                    }
                }
            }
            
            // Connect with Coinbase Wallet
            async function connectCoinbase() {
                try {
                    console.log('[Dave Contract] Connecting to Coinbase Wallet...');
                    
                    // Check if Coinbase Wallet extension is installed
                    if (window.ethereum?.isCoinbaseWallet) {
                        walletModal.classList.remove('show');
                        await connectWallet(window.ethereum);
                    } else {
                        // Use WalletConnect for Coinbase Wallet mobile
                        await connectWalletConnect();
                    }
                } catch (error) {
                    console.error('[Dave Contract] Coinbase Wallet error:', error);
                    showError('Coinbase Wallet connection failed');
                }
            }
            
            // Main connect wallet function
            async function connectWallet(walletProvider) {
                try {
                    clearMessages();
                    console.log('[Dave Contract] Starting connection...');
                    
                    executeButton.disabled = true;
                    executeButton.innerHTML = 'CONNECTING...';
                    
                    // Setup provider based on wallet type
                    if (walletProvider) {
                        provider = new window.ethers.providers.Web3Provider(walletProvider);
                    } else {
                        showError('No wallet provider found');
                        executeButton.disabled = false;
                        executeButton.innerHTML = 'CONNECT WALLET';
                        return;
                    }
                    
                    // Request accounts
                    let accounts;
                    try {
                        accounts = await provider.send('eth_requestAccounts', []);
                        console.log('[Dave Contract] Accounts:', accounts);
                    } catch (err) {
                        console.error('[Dave Contract] Account request error:', err);
                        showError('Failed to get accounts');
                        executeButton.disabled = false;
                        executeButton.innerHTML = 'CONNECT WALLET';
                        return;
                    }
                    
                    if (!accounts || accounts.length === 0) {
                        throw new Error('No accounts found');
                    }
                    
                    // Get current chain
                    const network = await provider.getNetwork();
                    console.log('[Dave Contract] Current network:', network);
                    
                    // Switch to Base if needed
                    if (network.chainId !== BASE_CHAIN_ID_DEC) {
                        try {
                            if (walletProvider === window.ethereum) {
                                // For injected provider
                                await walletProvider.request({
                                    method: 'wallet_switchEthereumChain',
                                    params: [{ chainId: BASE_CHAIN_ID }],
                                });
                            } else {
                                // For WalletConnect
                                showError('Please switch to Base network in your wallet');
                                executeButton.disabled = false;
                                executeButton.innerHTML = 'CONNECT WALLET';
                                return;
                            }
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                try {
                                    await walletProvider.request({
                                        method: 'wallet_addEthereumChain',
                                        params: [{
                                            chainId: BASE_CHAIN_ID,
                                            chainName: 'Base',
                                            nativeCurrency: {
                                                name: 'Ether',
                                                symbol: 'ETH',
                                                decimals: 18
                                            },
                                            rpcUrls: ['https://mainnet.base.org'],
                                            blockExplorerUrls: ['https://basescan.org/']
                                        }],
                                    });
                                } catch (addError) {
                                    showError('Please add Base network to your wallet');
                                    executeButton.disabled = false;
                                    executeButton.innerHTML = 'CONNECT WALLET';
                                    return;
                                }
                            } else {
                                showError('Please switch to Base network');
                                executeButton.disabled = false;
                                executeButton.innerHTML = 'CONNECT WALLET';
                                return;
                            }
                        }
                        
                        // Re-check network after switch
                        const newNetwork = await provider.getNetwork();
                        if (newNetwork.chainId !== BASE_CHAIN_ID_DEC) {
                            throw new Error('Wrong network after switch');
                        }
                    }
                    
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    console.log('[Dave Contract] User address:', userAddress);
                    
                    // Setup contracts
                    contract = new window.ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    
                    if (NFT_CONTRACT_ADDRESS !== 'YOUR_NFT_CONTRACT_ADDRESS_HERE') {
                        nftContract = new window.ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_CONTRACT_ABI, signer);
                    }
                    
                    // Check if already signed
                    let hasSigned = false;
                    try {
                        hasSigned = await contract.hasSigned(userAddress);
                        console.log('[Dave Contract] Has signed:', hasSigned);
                    } catch (err) {
                        console.error('[Dave Contract] Error checking signature status:', err);
                    }
                    
                    // Update wallet status
                    walletAddress.textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                    walletStatus.classList.add('connected');
                    
                    if (hasSigned) {
                        console.log('[Dave Contract] User already signed, showing NFT preview');
                        const shown = await showExistingSignature();
                        if (!shown) {
                            executeButton.innerHTML = 'ALREADY SIGNED';
                            executeButton.disabled = true;
                        }
                    } else {
                        connected = true;
                        executeButton.innerHTML = 'EXECUTE TRANSACTION';
                        executeButton.disabled = false;
                        console.log('[Dave Contract] Connection successful! Ready to sign.');
                    }
                    
                } catch (error) {
                    console.error('[Dave Contract] Connection error:', error);
                    executeButton.disabled = false;
                    executeButton.innerHTML = 'CONNECT WALLET';
                    showError('Connection failed. Please try again.');
                }
            }
            
            // Sign declaration
            async function signDeclaration() {
                try {
                    clearMessages();
                    
                    const name = (isMobile ? mobileNameInput.value : nameInput.value).trim().toLowerCase();
                    
                    if (!name) {
                        showError('Please enter a name');
                        return;
                    }
                    
                    if (name.length > 14) {
                        showError('Name cannot exceed 14 characters');
                        return;
                    }
                    
                    if (!/^[a-z0-9-]+$/.test(name)) {
                        showError('Only lowercase letters, numbers, and hyphens allowed');
                        return;
                    }
                    
                    const fullName = `i_am_${name}_dave`;
                    const nameExists = await contract.nameExists(fullName);
                    if (nameExists) {
                        showError('This DAVE name is already taken');
                        return;
                    }
                    
                    executeButton.disabled = true;
                    executeButton.innerHTML = 'SIGNING<span class="loading-spinner"></span>';
                    
                    const tx = await contract.cosignDeclaration(name);
                    console.log('[Dave Contract] Transaction sent:', tx.hash);
                    currentTxHash = tx.hash;
                    
                    executeButton.innerHTML = 'CONFIRMING<span class="loading-spinner"></span>';
                    
                    const txReceipt = await tx.wait();
                    console.log('[Dave Contract] Transaction confirmed');
                    
                    let signatureNumber = 'N/A';
                    const event = txReceipt.events?.find(e => e.event === 'DeclarationSigned');
                    if (event) {
                        signatureNumber = event.args.signatureNumber.toString();
                    }
                    
                    signatureData = {
                        daveName: fullName,
                        signatureNumber: signatureNumber,
                        blockNumber: txReceipt.blockNumber,
                        timestamp: Date.now()
                    };
                    
                    nameInput.value = '';
                    mobileNameInput.value = '';
                    nameInput.disabled = true;
                    mobileNameInput.disabled = true;
                    inputLine.classList.add('disabled');
                    mobileInputLine.classList.add('disabled');
                    document.querySelector('.preview-comment .comment').textContent = '// ';
                    preview.textContent = 'THE BANKSY STAYS ON THE WALL';
                    executeButton.innerHTML = 'SIGNED';
                    executeButton.disabled = true;
                    
                    collapseTopFrame();
                    
                    nftContent.innerHTML = generateNFTPreview(
                        fullName,
                        signatureNumber,
                        txReceipt.blockNumber,
                        tx.hash,
                        userAddress
                    );
                    
                    nftPreview.classList.add('show');
                    mintButtonContainer.classList.add('show');
                    
                    setTimeout(() => {
                        if (window.parent !== window) {
                            window.parent.postMessage({
                                type: 'resize',
                                height: document.body.scrollHeight
                            }, '*');
                        }
                    }, 100);
                    
                } catch (error) {
                    console.error('[Dave Contract] Sign error:', error);
                    executeButton.disabled = false;
                    executeButton.innerHTML = 'EXECUTE TRANSACTION';
                    
                    if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                        showError('Transaction cancelled');
                    } else if (error.message?.includes('allowlisted')) {
                        showError('Only allowlisted addresses can sign during this period');
                    } else {
                        showError('Transaction failed. Please try again.');
                    }
                }
            }
            
            // Mint NFT
            async function mintNFT() {
                if (!nftContract) {
                    showError('NFT contract not deployed yet');
                    return;
                }
                
                if (!signatureData) {
                    showError('Signature data not found');
                    return;
                }
                
                try {
                    mintButton.disabled = true;
                    mintButton.innerHTML = 'MINTING<span class="loading-spinner"></span>';
                    
                    const mintPrice = await nftContract.MINT_PRICE();
                    const txHashToUse = currentTxHash || '0x0000000000000000000000000000000000000000000000000000000000000000';
                    
                    const tx = await nftContract.mint(
                        txHashToUse,
                        signatureData.signatureNumber,
                        signatureData.blockNumber,
                        {
                            value: mintPrice
                        }
                    );
                    
                    console.log('[Dave Contract] NFT mint transaction sent:', tx.hash);
                    
                    mintButton.innerHTML = 'CONFIRMING<span class="loading-spinner"></span>';
                    
                    const receipt = await tx.wait();
                    console.log('[Dave Contract] NFT minted successfully');
                    
                    const tokenId = await nftContract.addressToTokenId(userAddress);
                    
                    mintButtonContainer.classList.remove('show');
                    successText.textContent = `NFT #${tokenId} Minted Successfully!`;
                    openSeaLink.href = `https://opensea.io/assets/base/${NFT_CONTRACT_ADDRESS}/${tokenId}`;
                    successMessage.classList.add('show');
                    
                } catch (error) {
                    console.error('[Dave Contract] Mint error:', error);
                    mintButton.disabled = false;
                    mintButton.innerHTML = 'MINT AS NFT (0.001439 ETH)';
                    
                    if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                        showError('Transaction cancelled');
                    } else if (error.message?.includes('Already minted')) {
                        showError('You have already minted your NFT');
                    } else if (error.message?.includes('Insufficient')) {
                        showError('Insufficient funds for minting');
                    } else {
                        showError('Minting failed. Please try again.');
                    }
                }
            }
            
            // Wallet option click handlers
            metamaskOption.addEventListener('click', connectInjected);
            walletConnectOption.addEventListener('click', connectWalletConnect);
            coinbaseOption.addEventListener('click', connectCoinbase);
            
            // Button handlers
            executeButton.addEventListener('click', async () => {
                if (!connected) {
                    showWalletModal();
                } else {
                    await signDeclaration();
                }
            });
            
            mintButton.addEventListener('click', mintNFT);
            
            // Enter key handlers
            nameInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && connected && !nameInput.disabled) {
                    await signDeclaration();
                }
            });
            
            mobileNameInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && connected && !mobileNameInput.disabled) {
                    await signDeclaration();
                }
            });
            
            // Listen for account/network changes
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        connected = false;
                        executeButton.innerHTML = 'CONNECT WALLET';
                        executeButton.disabled = false;
                        walletStatus.classList.remove('connected');
                        clearMessages();
                        // Reset UI
                        nameInput.disabled = false;
                        mobileNameInput.disabled = false;
                        inputLine.classList.remove('disabled');
                        mobileInputLine.classList.remove('disabled');
                        contractContainer.classList.remove('collapsed');
                        nftPreview.classList.remove('show');
                        mintButtonContainer.classList.remove('show');
                        successMessage.classList.remove('show');
                    } else if (connected && accounts[0].toLowerCase() !== userAddress.toLowerCase()) {
                        window.location.reload();
                    }
                });
                
                window.ethereum.on('chainChanged', (chainId) => {
                    if (connected && chainId !== BASE_CHAIN_ID) {
                        showError('Please switch back to Base network');
                        connected = false;
                        executeButton.innerHTML = 'CONNECT WALLET';
                        executeButton.disabled = false;
                    }
                });
            }
            
            // Auto-focus input (desktop only)
            if (!isMobile) {
                nameInput.focus();
            }
            
            console.log('[Dave Contract] Widget initialized with WalletConnect support');
        });
    </script>
</body>
</html>
