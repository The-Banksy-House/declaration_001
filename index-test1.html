<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Declaration of the Daves - Sign the Contract</title>
    
    <!-- Allow embedding in iframes -->
    <meta http-equiv="X-Frame-Options" content="ALLOWALL">
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0d1117;
            color: #c9d1d9;
            font-family: 'JetBrains Mono', monospace;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .widget-container {
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Main contract container - square format for desktop */
        .contract-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            width: 100%;
            aspect-ratio: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Collapsed state for mobile after signing */
        .contract-container.collapsed {
            aspect-ratio: unset;
            height: auto;
        }
        
        .contract-header {
            background: #0d1117;
            border-bottom: 1px solid #30363d;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-icon {
            color: #7ee787;
        }
        
        .filename {
            color: #f0f6fc;
            font-size: 14px;
        }
        
        .network-badge {
            margin-left: auto;
            background: #1f6feb;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .code-editor {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            padding: 40px 0;
        }
        
        /* Hide code editor when collapsed */
        .contract-container.collapsed .code-editor {
            display: none;
        }
        
        .line-numbers {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            text-align: right;
            color: #484f58;
            font-size: 12px;
            line-height: 20px;
            user-select: none;
        }
        
        .code-content {
            margin-left: 70px;
            margin-right: 40px;
            font-size: 12px;
            line-height: 20px;
            width: calc(100% - 110px);
        }
        
        /* Syntax highlighting */
        .comment {
            color: #8b949e;
            font-style: italic;
        }
        
        .keyword {
            color: #ff7b72;
        }
        
        .function-name {
            color: #d2a8ff;
        }
        
        .type {
            color: #79c0ff;
        }
        
        .string {
            color: #a5d6ff;
        }
        
        .parameter {
            color: #ffa657;
        }
        
        .address {
            color: #7ee787;
            font-size: 12px;
            word-break: break-all;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .number {
            color: #79c0ff;
        }
        
        /* Input styling */
        .input-line {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 8px 0;
            display: inline-flex;
            align-items: center;
            transition: border-color 0.2s;
            white-space: nowrap;
        }
        
        .input-line:hover {
            border-color: #58a6ff;
        }
        
        .input-line.focused {
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        .input-line.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .input-prefix, .input-suffix {
            color: #a5d6ff;
            font-size: 12px;
        }
        
        .name-input {
            background: none;
            border: none;
            color: #a5d6ff;
            font-family: inherit;
            font-size: 12px;
            outline: none;
            width: 140px;
            margin: 0 4px;
        }
        
        /* Mobile input styling */
        .mobile-input-line {
            display: none;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            width: 100%;
        }
        
        .mobile-input {
            background: none;
            border: none;
            color: #a5d6ff;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            width: 100%;
        }
        
        /* Preview section */
        .preview-comment {
            margin-top: 16px;
            padding: 8px;
            background: #0d1117;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .preview-comment .comment {
            font-size: 12px;
        }
        
        .preview-comment .string {
            font-size: 12px;
        }
        
        /* Action section */
        .action-section {
            background: #0d1117;
            border-top: 1px solid #30363d;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* Hide action section when collapsed except for button */
        .contract-container.collapsed .action-section {
            border-top: none;
            padding: 12px 20px;
        }
        
        .contract-info {
            font-size: 12px;
        }
        
        .contract-container.collapsed .contract-info {
            display: none;
        }
        
        .contract-label {
            color: #8b949e;
            margin-bottom: 4px;
        }
        
        .contract-address-link {
            color: #7ee787;
            text-decoration: none;
            transition: opacity 0.2s;
        }
        
        .contract-address-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
        
        .execute-button {
            background: #f78166;
            color: #0d1117;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .execute-button:hover:not(:disabled) {
            background: #ff8c73;
            transform: translateY(-1px);
        }
        
        .execute-button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .execute-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Connected status */
        .wallet-status {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            color: #7ee787;
            display: none;
            align-items: center;
            gap: 6px;
        }
        
        .wallet-status.connected {
            display: flex;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #7ee787;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Error state */
        .error-message {
            background: #f85149;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin: 8px 0;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* NFT Preview - Square format */
        .nft-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            width: 100%;
            aspect-ratio: 1;
            margin: 40px auto 20px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .nft-container.show {
            display: flex;
        }
        
        .nft-code-editor {
            position: relative;
            width: 100%;
            padding: 40px 0;
        }
        
        .nft-line-numbers {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            text-align: right;
            color: #484f58;
            font-size: 12px;
            line-height: 20px;
            user-select: none;
        }
        
        .nft-code-content {
            margin-left: 70px;
            margin-right: 40px;
            font-size: 12px;
            line-height: 20px;
        }
        
        /* Mint button */
        .mint-button-container {
            text-align: center;
            margin-bottom: 40px;
            display: none;
        }
        
        .mint-button-container.show {
            display: block;
        }
        
        .mint-button {
            background: #f78166;
            color: #0d1117;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mint-button:hover:not(:disabled) {
            background: #ff8c73;
            transform: translateY(-1px);
        }
        
        .mint-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #0d1117;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Success message */
        .success-message {
            background: #238636;
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }
        
        .success-message.show {
            display: block;
        }
        
        .success-message a {
            color: #7ee787;
            text-decoration: none;
        }
        
        .success-message a:hover {
            text-decoration: underline;
        }
        
        /* Mobile wallet prompt */
        .mobile-wallet-prompt {
            background: #1f6feb;
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            margin: 12px 0;
            text-align: center;
            display: none;
        }
        
        .mobile-wallet-prompt.show {
            display: block;
        }
        
        .mobile-wallet-prompt a {
            color: white;
            text-decoration: underline;
        }
        
        /* Mobile specific styles */
        @media (max-width: 600px) {
            body {
                padding: 0;
                align-items: flex-start;
            }
            
            .widget-container {
                max-width: 100%;
                padding: 20px;
            }
            
            /* Top frame - remove square constraint on mobile */
            .contract-container {
                aspect-ratio: unset;
                height: auto;
                border-radius: 6px;
            }
            
            /* Keep header the same */
            .contract-header {
                padding: 10px 16px;
            }
            
            .filename {
                font-size: 13px;
            }
            
            .network-badge {
                font-size: 11px;
                padding: 3px 10px;
            }
            
            /* Adjust code editor for mobile */
            .code-editor {
                padding: 30px 0;
                align-items: flex-start;
            }
            
            .line-numbers {
                position: static;
                transform: none;
                margin-left: 16px;
                margin-top: 0;
            }
            
            .code-content {
                margin-left: 60px;
                margin-right: 16px;
                width: calc(100% - 76px);
            }
            
            /* Hide desktop input, show mobile input */
            .input-line {
                display: none;
            }
            
            .mobile-input-line {
                display: block;
                margin: 12px 0;
            }
            
            .mobile-input-line.focused {
                border-color: #58a6ff;
                box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
            }
            
            .mobile-input-line.disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            /* Action section adjustments */
            .action-section {
                padding: 16px;
                flex-direction: column;
                gap: 12px;
            }
            
            .contract-info {
                width: 100%;
                text-align: center;
            }
            
            .execute-button {
                width: 100%;
                font-size: 13px;
                padding: 12px 20px;
            }
            
            /* NFT Preview - smaller but still square */
            .nft-container {
                margin: 20px auto 16px;
                aspect-ratio: 1;
            }
            
            /* Scale down NFT content */
            .nft-code-editor {
                padding: 20px 0;
            }
            
            .nft-line-numbers {
                left: 12px;
                font-size: 9px;
                line-height: 14px;
                width: 20px;
            }
            
            .nft-code-content {
                margin-left: 40px;
                margin-right: 12px;
                font-size: 9px;
                line-height: 14px;
            }
            
            .nft-code-content .comment {
                font-size: 9px;
            }
            
            .nft-code-content .address {
                font-size: 9px;
            }
            
            /* Mint button adjustments */
            .mint-button-container {
                margin-bottom: 20px;
            }
            
            .mint-button {
                width: 100%;
                font-size: 13px;
                padding: 12px 20px;
            }
            
            /* Wallet status position */
            .wallet-status {
                position: static;
                margin: 10px 16px;
                font-size: 11px;
            }
            
            /* Error message */
            .error-message {
                font-size: 11px;
                margin: 8px 16px;
            }
            
            /* Success message */
            .success-message {
                font-size: 11px;
                margin: 16px 0;
            }
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <!-- Main Widget -->
        <div class="contract-container" id="contractContainer">
            <!-- Header -->
            <div class="contract-header">
                <span class="file-icon">üìÑ</span>
                <span class="filename">DeclarationOfTheDaves.sol</span>
                <span class="network-badge">Base Mainnet</span>
            </div>
            
            <!-- Wallet Status -->
            <div class="wallet-status" id="walletStatus">
                <span class="status-dot"></span>
                <span id="walletAddress">Connected</span>
            </div>
            
            <!-- Code Editor -->
            <div class="code-editor">
                <div class="line-numbers">
                    <div>1</div>
                    <div>2</div>
                    <div>3</div>
                    <div>4</div>
                    <div>5</div>
                    <div>6</div>
                    <div>7</div>
                    <div>8</div>
                    <div>9</div>
                    <div>10</div>
                    <div>11</div>
                    <div>12</div>
                    <div>13</div>
                    <div>14</div>
                    <div>15</div>
                    <div>16</div>
                    <div>17</div>
                </div>
                
                <div class="code-content">
                    <div><span class="keyword">pragma</span> <span class="type">solidity</span> ^0.8.19;</div>
                    <br>
                    <div class="comment">/**</div>
                    <div class="comment"> * @title THE DECLARATION OF THE DAVES 001</div>
                    <div class="comment"> * @notice THE BANKSY STAYS ON THE WALL</div>
                    <div class="comment"> * @dev This contract is the art. Immutable. Permanent. Public.</div>
                    <div class="comment"> * @dev Co-sign the declaration by calling this function</div>
                    <div class="comment"> */</div>
                    <br>
                    <div><span class="keyword">function</span> <span class="function-name">cosignDeclaration</span>(<span class="type">string</span> <span class="type">memory</span> <span class="parameter">chosenName</span>) <span class="keyword">public</span> {</div>
                    <div style="margin-left: 20px;">
                        <div class="comment">// Enter your chosen name (lowercase, max 14 chars)</div>
                        <!-- Desktop input -->
                        <div class="input-line" id="inputLine" onclick="focusInput()">
                            <span class="input-prefix">require(chosenName == "</span>
                            <input type="text" class="name-input" id="nameInput" placeholder="your_name" maxlength="14" autocomplete="off" spellcheck="false">
                            <span class="input-suffix">", "Enter name");</span>
                        </div>
                        <!-- Mobile input -->
                        <div class="mobile-input-line" id="mobileInputLine">
                            <input type="text" class="mobile-input" id="mobileNameInput" placeholder="Enter your name (lowercase, max 14 chars)" maxlength="14" autocomplete="off" spellcheck="false">
                        </div>
                        <div class="preview-comment">
                            <span class="comment">// Your signature will be: </span>
                            <span class="string" id="preview">i_am_your_name_dave</span>
                        </div>
                    </div>
                    <div>}</div>
                    
                    <div class="error-message" id="errorMsg">
                        ‚ö†Ô∏è <span id="errorText">Name can only contain lowercase letters, numbers, and hyphens</span>
                    </div>
                    
                    <div class="mobile-wallet-prompt" id="mobileWalletPrompt">
                        üì± Please open this page in your wallet's browser (MetaMask, Trust Wallet, etc.) or use a desktop browser with MetaMask extension.
                    </div>
                </div>
            </div>
            
            <!-- Action Section -->
            <div class="action-section">
                <div class="contract-info">
                    <div class="contract-label">Contract</div>
                    <a href="https://basescan.org/address/0xB0731E7ea189c169640Fd890E5dcE9811040D0eA#code" 
                       target="_blank" 
                       rel="noopener noreferrer" 
                       class="contract-address-link">
                        0xB0731E7ea189c169640Fd890E5dcE9811040D0eA
                    </a>
                </div>
                <button class="execute-button" id="executeButton">CONNECT WALLET</button>
            </div>
        </div>
        
        <!-- NFT Preview (hidden until transaction complete or already signed) -->
        <div class="nft-container" id="nftPreview">
            <div class="nft-code-editor">
                <div class="nft-line-numbers">
                    <div>1</div>
                    <div>2</div>
                    <div>3</div>
                    <div>4</div>
                    <div>5</div>
                    <div>6</div>
                    <div>7</div>
                    <div>8</div>
                    <div>9</div>
                    <div>10</div>
                    <div>11</div>
                    <div>12</div>
                    <div>13</div>
                    <div>14</div>
                </div>
                
                <div class="nft-code-content" id="nftContent">
                    <!-- NFT content will be populated dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Mint Button (hidden until transaction complete or already signed) -->
        <div class="mint-button-container" id="mintButtonContainer">
            <button class="mint-button" id="mintButton">MINT AS NFT (0.001439 ETH)</button>
        </div>
        
        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            <div id="successText">NFT Minted Successfully!</div>
            <div style="margin-top: 8px;">
                <a id="openSeaLink" href="#" target="_blank" rel="noopener noreferrer">View on OpenSea ‚Üí</a>
            </div>
        </div>
    </div>

    <script>
        // Mobile wallet detection
        function detectMobileWallet() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
            
            // Check if ethereum object exists (injected by wallet)
            const hasEthereum = typeof window.ethereum !== 'undefined';
            const hasWeb3 = typeof window.web3 !== 'undefined';
            
            // Check if we're in a dApp browser by user agent
            const isDappBrowser = 
                hasEthereum ||
                hasWeb3 ||
                userAgent.includes('metamask') ||
                userAgent.includes('trust') ||
                userAgent.includes('coinbase') ||
                userAgent.includes('tokenpocket') ||
                userAgent.includes('imtoken') ||
                userAgent.includes('mathwallet');
            
            // On mobile, sometimes ethereum injection is delayed
            // So we should wait a bit before deciding
            if (isMobile && !hasEthereum && !hasWeb3) {
                // Check again after a short delay
                setTimeout(() => {
                    if (typeof window.ethereum !== 'undefined') {
                        console.log('[Dave Contract] Ethereum detected after delay');
                        // Hide the prompt if it's showing
                        const prompt = document.getElementById('mobileWalletPrompt');
                        if (prompt) {
                            prompt.classList.remove('show');
                        }
                    }
                }, 1500);
            }
            
            return {
                isMobile,
                isDappBrowser,
                hasWallet: hasEthereum || hasWeb3
            };
        }
        
        // Load ethers.js with better error handling
        function loadEthers(callback) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
            script.onload = callback;
            script.onerror = function() {
                // Try alternative CDN
                const altScript = document.createElement('script');
                altScript.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
                altScript.onload = callback;
                altScript.onerror = function() {
                    showError('Failed to load Web3 library. Please refresh the page.');
                };
                document.head.appendChild(altScript);
            };
            document.head.appendChild(script);
        }
        
        // Initialize widget after ethers loads
        loadEthers(function() {
            console.log('[Dave Contract] Ethers loaded successfully');
            
            // Contract details
            const CONTRACT_ADDRESS = '0xB0731E7ea189c169640Fd890E5dcE9811040D0eA';
            
            // TODO: REPLACE THIS WITH YOUR DEPLOYED NFT CONTRACT ADDRESS
            const NFT_CONTRACT_ADDRESS = 'YOUR_NFT_CONTRACT_ADDRESS_HERE';
            
            const BASE_CHAIN_ID = '0x2105'; // 8453 in hex
            const BASE_CHAIN_ID_DEC = 8453;
            
            // CORRECTED CONTRACT ABI - Matching actual deployed contract
            const CONTRACT_ABI = [
                "function cosignDeclaration(string memory chosenName) public",
                "function hasSigned(address) public view returns (bool)",
                "function signatureByAddress(address) public view returns (string)",
                "function allSignatures(uint256) public view returns (tuple(string daveName, address signatory, uint256 timestamp, uint256 blockNumber))",
                "function totalSignatures() public view returns (uint256)",
                "function nameExists(string) public view returns (bool)",
                "function isAllowlistActive() public view returns (bool)",
                "function timeUntilPublic() public view returns (uint256)",
                "function getSignature(uint256) public view returns (string daveName, address signatory, uint256 timestamp, uint256 blockNumber)",
                "event DeclarationSigned(address indexed signatory, string daveName, uint256 signatureNumber, uint256 blockNumber)"
            ];
            
            const NFT_CONTRACT_ABI = [
                "function mint(bytes32 _originalTxHash, uint256 _signatureNumber, uint256 _blockNumber) public payable",
                "function hasMinted(address) public view returns (bool)",
                "function addressToTokenId(address) public view returns (uint256)",
                "function MINT_PRICE() public view returns (uint256)"
            ];
            
            // State
            let provider = null;
            let signer = null;
            let contract = null;
            let nftContract = null;
            let connected = false;
            let userAddress = null;
            let currentTxHash = null;
            let signatureData = null;
            
            // Elements
            const contractContainer = document.getElementById('contractContainer');
            const executeButton = document.getElementById('executeButton');
            const nameInput = document.getElementById('nameInput');
            const mobileNameInput = document.getElementById('mobileNameInput');
            const errorMsg = document.getElementById('errorMsg');
            const errorText = document.getElementById('errorText');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const preview = document.getElementById('preview');
            const inputLine = document.getElementById('inputLine');
            const mobileInputLine = document.getElementById('mobileInputLine');
            const nftPreview = document.getElementById('nftPreview');
            const nftContent = document.getElementById('nftContent');
            const mintButtonContainer = document.getElementById('mintButtonContainer');
            const mintButton = document.getElementById('mintButton');
            const successMessage = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            const openSeaLink = document.getElementById('openSeaLink');
            const mobileWalletPrompt = document.getElementById('mobileWalletPrompt');
            
            // Check wallet availability
            const walletInfo = detectMobileWallet();
            const isMobile = window.innerWidth <= 600 || walletInfo.isMobile;
            
            // Focus input helper
            window.focusInput = function() {
                if (!nameInput.disabled && !isMobile) {
                    nameInput.focus();
                }
            };
            
            // Sync desktop and mobile inputs
            function syncInputs(source, target) {
                target.value = source.value;
                const value = source.value.toLowerCase();
                
                if (value) {
                    preview.textContent = `i_am_${value}_dave`;
                } else {
                    preview.textContent = 'i_am_your_name_dave';
                }
                
                // Clear error on typing
                errorMsg.classList.remove('show');
                mobileWalletPrompt.classList.remove('show');
            }
            
            // Desktop input handlers
            nameInput.addEventListener('focus', () => {
                inputLine.classList.add('focused');
            });
            
            nameInput.addEventListener('blur', () => {
                inputLine.classList.remove('focused');
            });
            
            nameInput.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                e.target.value = value;
                syncInputs(nameInput, mobileNameInput);
            });
            
            // Mobile input handlers
            mobileNameInput.addEventListener('focus', () => {
                mobileInputLine.classList.add('focused');
            });
            
            mobileNameInput.addEventListener('blur', () => {
                mobileInputLine.classList.remove('focused');
            });
            
            mobileNameInput.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                e.target.value = value;
                syncInputs(mobileNameInput, nameInput);
            });
            
            // Error handling
            function showError(message) {
                console.error('[Dave Contract] Error:', message);
                errorText.textContent = message;
                errorMsg.classList.add('show');
                setTimeout(() => {
                    errorMsg.classList.remove('show');
                }, 7000);
            }
            
            function clearMessages() {
                errorMsg.classList.remove('show');
                mobileWalletPrompt.classList.remove('show');
            }
            
            // Generate NFT preview content
            function generateNFTPreview(daveName, signatureNumber, blockNumber, txHash, signerAddr) {
                const shortName = daveName.replace('i_am_', '').replace('_dave', '');
                return `<div class="comment">/**</div>
<div class="comment"> * @title THE DECLARATION OF THE DAVES 001</div>
<div class="comment"> * Contract: 0xB0731E7ea189c169640Fd890E5dcE9811040D0eA</div>
<div class="comment"> * @notice THE BANKSY STAYS ON THE WALL</div>
<div class="comment"> * Signed by: <span class="number">${shortName}_dave</span></div>
<div class="comment"> */</div>
<br>
<div class="comment">// Signature Number: <span class="number">#${signatureNumber}</span></div>
<div class="comment">// Block Number: <span class="number">${blockNumber}</span></div>
<br>
<div class="comment">// Transaction Hash:</div>
<div class="address">${txHash}</div>
<br>
<div class="comment">// Signer Address:</div>
<div class="address">${signerAddr}</div>`;
            }
            
            // Get signature data for an address - CORRECTED to use allSignatures
            async function getSignatureData(address) {
                try {
                    console.log('[Dave Contract] Getting signature data for:', address);
                    
                    // First check if they've signed
                    const hasSigned = await contract.hasSigned(address);
                    console.log('[Dave Contract] Has signed:', hasSigned);
                    
                    if (!hasSigned) {
                        return null;
                    }
                    
                    // Get their signature string
                    const daveName = await contract.signatureByAddress(address);
                    console.log('[Dave Contract] Dave name:', daveName);
                    
                    // Get total signatures to search through
                    const totalSigs = await contract.totalSignatures();
                    console.log('[Dave Contract] Total signatures:', totalSigs.toString());
                    
                    // Search through signatures using allSignatures function
                    // Note: allSignatures returns a struct, we need to handle it properly
                    for (let i = 0; i < totalSigs; i++) {
                        try {
                            console.log(`[Dave Contract] Checking signature at index ${i}...`);
                            
                            // Call allSignatures which returns a tuple/struct
                            const sig = await contract.allSignatures(i);
                            
                            // The struct has properties: daveName, signatory, timestamp, blockNumber
                            // Access them directly or by index depending on ethers.js version
                            let sigAddress;
                            let sigDaveName;
                            let sigTimestamp;
                            let sigBlockNumber;
                            
                            // Try accessing as object properties first
                            if (sig.signatory) {
                                sigAddress = sig.signatory;
                                sigDaveName = sig.daveName;
                                sigTimestamp = sig.timestamp;
                                sigBlockNumber = sig.blockNumber;
                            } else if (Array.isArray(sig)) {
                                // If it's returned as array (older ethers.js)
                                sigDaveName = sig[0];
                                sigAddress = sig[1];
                                sigTimestamp = sig[2];
                                sigBlockNumber = sig[3];
                            } else {
                                console.log('[Dave Contract] Unexpected signature format:', sig);
                                continue;
                            }
                            
                            console.log(`[Dave Contract] Signature ${i}: address=${sigAddress}, name=${sigDaveName}`);
                            
                            if (sigAddress && sigAddress.toLowerCase() === address.toLowerCase()) {
                                console.log('[Dave Contract] Found matching signature at index:', i);
                                return {
                                    daveName: sigDaveName || daveName,
                                    signatureNumber: i + 1,  // Convert 0-indexed to 1-indexed
                                    blockNumber: sigBlockNumber ? sigBlockNumber.toString() : 'Unknown',
                                    timestamp: sigTimestamp ? sigTimestamp.toString() : 'Unknown'
                                };
                            }
                        } catch (err) {
                            console.error(`[Dave Contract] Error reading signature ${i}:`, err);
                            
                            // Try using getSignature function as fallback for this index
                            try {
                                console.log(`[Dave Contract] Trying getSignature for index ${i}...`);
                                const sigData = await contract.getSignature(i);
                                
                                // getSignature returns: (string daveName, address signatory, uint256 timestamp, uint256 blockNumber)
                                const [gDaveName, gSignatory, gTimestamp, gBlockNumber] = sigData;
                                
                                console.log(`[Dave Contract] getSignature ${i}: address=${gSignatory}, name=${gDaveName}`);
                                
                                if (gSignatory && gSignatory.toLowerCase() === address.toLowerCase()) {
                                    console.log('[Dave Contract] Found via getSignature at index:', i);
                                    return {
                                        daveName: gDaveName || daveName,
                                        signatureNumber: i + 1,
                                        blockNumber: gBlockNumber ? gBlockNumber.toString() : 'Unknown',
                                        timestamp: gTimestamp ? gTimestamp.toString() : 'Unknown'
                                    };
                                }
                            } catch (getSignatureErr) {
                                console.error(`[Dave Contract] getSignature also failed for index ${i}:`, getSignatureErr);
                            }
                        }
                    }
                    
                    // If we have a daveName but couldn't find complete data, warn but return what we have
                    if (daveName) {
                        console.warn('[Dave Contract] WARNING: Could not find complete signature data in array');
                        console.log('[Dave Contract] This might mean the signature was made before array tracking');
                        return {
                            daveName: daveName,
                            signatureNumber: 'Unknown',
                            blockNumber: 'Unknown',
                            timestamp: 'Unknown'
                        };
                    }
                    
                    return null;
                } catch (error) {
                    console.error('[Dave Contract] Critical error in getSignatureData:', error);
                    
                    // Last resort: if we at least have the dave name, return that
                    try {
                        const daveName = await contract.signatureByAddress(address);
                        if (daveName) {
                            return {
                                daveName: daveName,
                                signatureNumber: 'Unknown',
                                blockNumber: 'Unknown',
                                timestamp: 'Unknown'
                            };
                        }
                    } catch (finalErr) {
                        console.error('[Dave Contract] Could not even get dave name:', finalErr);
                    }
                    
                    return null;
                }
            }
            
            // Check NFT minting status
            async function checkNFTStatus() {
                if (!nftContract || NFT_CONTRACT_ADDRESS === 'YOUR_NFT_CONTRACT_ADDRESS_HERE') {
                    return { canMint: true, hasMinted: false };
                }
                
                try {
                    const hasMinted = await nftContract.hasMinted(userAddress);
                    return { canMint: !hasMinted, hasMinted };
                } catch (error) {
                    console.error('[Dave Contract] Error checking NFT status:', error);
                    return { canMint: true, hasMinted: false };
                }
            }
            
            // Collapse top frame on mobile after signing
            function collapseTopFrame() {
                if (isMobile) {
                    contractContainer.classList.add('collapsed');
                }
            }
            
            // Show NFT preview for already-signed users
            async function showExistingSignature() {
                // Get signature data
                signatureData = await getSignatureData(userAddress);
                
                if (!signatureData) {
                    console.log('[Dave Contract] No signature data found for user');
                    return false;
                }
                
                console.log('[Dave Contract] Showing existing signature:', signatureData);
                
                // Update UI for already-signed state
                nameInput.disabled = true;
                mobileNameInput.disabled = true;
                nameInput.value = '';
                mobileNameInput.value = '';
                inputLine.classList.add('disabled');
                mobileInputLine.classList.add('disabled');
                document.querySelector('.preview-comment .comment').textContent = '// ';
                preview.textContent = 'THE BANKSY STAYS ON THE WALL';
                executeButton.innerHTML = 'SIGNED';
                executeButton.disabled = true;
                
                // Collapse top frame on mobile
                collapseTopFrame();
                
                // Generate and show NFT preview
                // Note: We don't have the original tx hash, so showing placeholder
                nftContent.innerHTML = generateNFTPreview(
                    signatureData.daveName,
                    signatureData.signatureNumber,
                    signatureData.blockNumber,
                    '0x... (retroactive mint - original tx not stored)',
                    userAddress
                );
                
                nftPreview.classList.add('show');
                
                // Check if they can mint
                const { canMint, hasMinted } = await checkNFTStatus();
                
                if (hasMinted && NFT_CONTRACT_ADDRESS !== 'YOUR_NFT_CONTRACT_ADDRESS_HERE') {
                    // Already minted - show success message instead of mint button
                    const tokenId = await nftContract.addressToTokenId(userAddress);
                    successText.textContent = `You already minted NFT #${tokenId}`;
                    openSeaLink.href = `https://opensea.io/assets/base/${NFT_CONTRACT_ADDRESS}/${tokenId}`;
                    successMessage.classList.add('show');
                } else if (canMint) {
                    // Can mint - show mint button
                    mintButtonContainer.classList.add('show');
                    
                    // Note about retroactive mint
                    mintButton.title = 'Retroactive mint - will be marked as pre-NFT signature';
                }
                
                // Send resize message to parent
                setTimeout(() => {
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'resize',
                            height: document.body.scrollHeight
                        }, '*');
                    }
                }, 100);
                
                return true;
            }
            
            // Connect wallet
            async function connectWallet() {
                try {
                    clearMessages();
                    console.log('[Dave Contract] Starting connection...');
                    console.log('[Dave Contract] Wallet info:', walletInfo);
                    console.log('[Dave Contract] Window.ethereum exists:', typeof window.ethereum !== 'undefined');
                    
                    // For mobile, wait a bit for wallet injection
                    if (walletInfo.isMobile && !window.ethereum) {
                        console.log('[Dave Contract] Mobile detected, waiting for wallet injection...');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // Check again
                        if (!window.ethereum) {
                            console.log('[Dave Contract] Still no ethereum object after wait');
                            if (!walletInfo.isDappBrowser) {
                                mobileWalletPrompt.classList.add('show');
                                return;
                            }
                        } else {
                            console.log('[Dave Contract] Ethereum object found after wait');
                        }
                    }
                    
                    // Final check for wallet
                    if (!window.ethereum) {
                        if (walletInfo.isMobile) {
                            mobileWalletPrompt.classList.add('show');
                        } else {
                            showError('Please install MetaMask or another Web3 wallet');
                        }
                        return;
                    }
                    
                    executeButton.disabled = true;
                    executeButton.innerHTML = 'CONNECTING...';
                    
                    // Request accounts with better error handling for mobile
                    let accounts;
                    try {
                        accounts = await window.ethereum.request({ 
                            method: 'eth_requestAccounts' 
                        });
                        console.log('[Dave Contract] Accounts:', accounts);
                    } catch (err) {
                        console.error('[Dave Contract] Account request error:', err);
                        if (err.code === -32002) {
                            showError('Please unlock your wallet');
                        } else if (err.code === 4001) {
                            showError('Connection rejected');
                        } else {
                            showError('Failed to connect wallet');
                        }
                        executeButton.disabled = false;
                        executeButton.innerHTML = 'CONNECT WALLET';
                        return;
                    }
                    
                    if (!accounts || accounts.length === 0) {
                        throw new Error('No accounts found');
                    }
                    
                    // Get current chain
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    console.log('[Dave Contract] Current chain:', chainId);
                    
                    // Switch to Base if needed
                    if (chainId !== BASE_CHAIN_ID) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: BASE_CHAIN_ID }],
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                try {
                                    await window.ethereum.request({
                                        method: 'wallet_addEthereumChain',
                                        params: [{
                                            chainId: BASE_CHAIN_ID,
                                            chainName: 'Base',
                                            nativeCurrency: {
                                                name: 'Ether',
                                                symbol: 'ETH',
                                                decimals: 18
                                            },
                                            rpcUrls: ['https://mainnet.base.org'],
                                            blockExplorerUrls: ['https://basescan.org/']
                                        }],
                                    });
                                } catch (addError) {
                                    showError('Please add Base network to your wallet');
                                    executeButton.disabled = false;
                                    executeButton.innerHTML = 'CONNECT WALLET';
                                    return;
                                }
                            } else {
                                showError('Please switch to Base network');
                                executeButton.disabled = false;
                                executeButton.innerHTML = 'CONNECT WALLET';
                                return;
                            }
                        }
                    }
                    
                    // Setup provider
                    provider = new window.ethers.providers.Web3Provider(window.ethereum);
                    const network = await provider.getNetwork();
                    console.log('[Dave Contract] Network:', network);
                    
                    if (network.chainId !== BASE_CHAIN_ID_DEC) {
                        throw new Error('Wrong network after switch');
                    }
                    
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    console.log('[Dave Contract] User address:', userAddress);
                    
                    // Setup contracts
                    contract = new window.ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    
                    // Setup NFT contract if deployed
                    if (NFT_CONTRACT_ADDRESS !== 'YOUR_NFT_CONTRACT_ADDRESS_HERE') {
                        nftContract = new window.ethers.Contract(NFT_CONTRACT_ADDRESS, NFT_CONTRACT_ABI, signer);
                    }
                    
                    // Check if already signed
                    let hasSigned = false;
                    try {
                        hasSigned = await contract.hasSigned(userAddress);
                        console.log('[Dave Contract] Has signed:', hasSigned);
                    } catch (err) {
                        console.error('[Dave Contract] Error checking signature status:', err);
                    }
                    
                    // Update wallet status
                    walletAddress.textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                    walletStatus.classList.add('connected');
                    
                    if (hasSigned) {
                        // User already signed - show their NFT preview
                        console.log('[Dave Contract] User already signed, showing NFT preview');
                        const shown = await showExistingSignature();
                        if (!shown) {
                            // If we couldn't show the signature, still update button
                            executeButton.innerHTML = 'ALREADY SIGNED';
                            executeButton.disabled = true;
                        }
                    } else {
                        // New user - enable signing
                        connected = true;
                        executeButton.innerHTML = 'EXECUTE TRANSACTION';
                        executeButton.disabled = false;
                        console.log('[Dave Contract] Connection successful! Ready to sign.');
                    }
                    
                } catch (error) {
                    console.error('[Dave Contract] Connection error:', error);
                    executeButton.disabled = false;
                    executeButton.innerHTML = 'CONNECT WALLET';
                    showError('Connection failed. Please try again.');
                }
            }
            
            // Sign declaration
            async function signDeclaration() {
                try {
                    clearMessages();
                    
                    const name = (isMobile ? mobileNameInput.value : nameInput.value).trim().toLowerCase();
                    
                    // Validate
                    if (!name) {
                        showError('Please enter a name');
                        return;
                    }
                    
                    if (name.length > 14) {
                        showError('Name cannot exceed 14 characters');
                        return;
                    }
                    
                    if (!/^[a-z0-9-]+$/.test(name)) {
                        showError('Only lowercase letters, numbers, and hyphens allowed');
                        return;
                    }
                    
                    // Check if name exists
                    const fullName = `i_am_${name}_dave`;
                    const nameExists = await contract.nameExists(fullName);
                    if (nameExists) {
                        showError('This DAVE name is already taken');
                        return;
                    }
                    
                    // Sign
                    executeButton.disabled = true;
                    executeButton.innerHTML = 'SIGNING<span class="loading-spinner"></span>';
                    
                    const tx = await contract.cosignDeclaration(name);
                    console.log('[Dave Contract] Transaction sent:', tx.hash);
                    currentTxHash = tx.hash;
                    
                    executeButton.innerHTML = 'CONFIRMING<span class="loading-spinner"></span>';
                    
                    const txReceipt = await tx.wait();
                    console.log('[Dave Contract] Transaction confirmed');
                    
                    // Get signature number from event
                    let signatureNumber = 'N/A';
                    const event = txReceipt.events?.find(e => e.event === 'DeclarationSigned');
                    if (event) {
                        signatureNumber = event.args.signatureNumber.toString();
                    }
                    
                    // Store signature data
                    signatureData = {
                        daveName: fullName,
                        signatureNumber: signatureNumber,
                        blockNumber: txReceipt.blockNumber,
                        timestamp: Date.now()
                    };
                    
                    // Update UI to show NFT preview
                    nameInput.value = '';
                    mobileNameInput.value = '';
                    nameInput.disabled = true;
                    mobileNameInput.disabled = true;
                    inputLine.classList.add('disabled');
                    mobileInputLine.classList.add('disabled');
                    document.querySelector('.preview-comment .comment').textContent = '// ';
                    preview.textContent = 'THE BANKSY STAYS ON THE WALL';
                    executeButton.innerHTML = 'SIGNED';
                    executeButton.disabled = true;
                    
                    // Collapse top frame on mobile
                    collapseTopFrame();
                    
                    // Generate and show NFT preview
                    nftContent.innerHTML = generateNFTPreview(
                        fullName,
                        signatureNumber,
                        txReceipt.blockNumber,
                        tx.hash,
                        userAddress
                    );
                    
                    nftPreview.classList.add('show');
                    mintButtonContainer.classList.add('show');
                    
                    // Send resize message to parent
                    setTimeout(() => {
                        if (window.parent !== window) {
                            window.parent.postMessage({
                                type: 'resize',
                                height: document.body.scrollHeight
                            }, '*');
                        }
                    }, 100);
                    
                } catch (error) {
                    console.error('[Dave Contract] Sign error:', error);
                    executeButton.disabled = false;
                    executeButton.innerHTML = 'EXECUTE TRANSACTION';
                    
                    if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                        showError('Transaction cancelled');
                    } else if (error.message?.includes('allowlisted')) {
                        showError('Only allowlisted addresses can sign during this period');
                    } else {
                        showError('Transaction failed. Please try again.');
                    }
                }
            }
            
            // Mint NFT
            async function mintNFT() {
                if (!nftContract) {
                    showError('NFT contract not deployed yet');
                    return;
                }
                
                if (!signatureData) {
                    showError('Signature data not found');
                    return;
                }
                
                try {
                    mintButton.disabled = true;
                    mintButton.innerHTML = 'MINTING<span class="loading-spinner"></span>';
                    
                    // Get mint price
                    const mintPrice = await nftContract.MINT_PRICE();
                    
                    // Use current tx hash if available, otherwise use empty bytes32 for retroactive
                    const txHashToUse = currentTxHash || '0x0000000000000000000000000000000000000000000000000000000000000000';
                    
                    // Mint NFT with signature number and block number
                    const tx = await nftContract.mint(
                        txHashToUse,
                        signatureData.signatureNumber,
                        signatureData.blockNumber,
                        {
                            value: mintPrice
                        }
                    );
                    
                    console.log('[Dave Contract] NFT mint transaction sent:', tx.hash);
                    
                    mintButton.innerHTML = 'CONFIRMING<span class="loading-spinner"></span>';
                    
                    const receipt = await tx.wait();
                    console.log('[Dave Contract] NFT minted successfully');
                    
                    // Get token ID
                    const tokenId = await nftContract.addressToTokenId(userAddress);
                    
                    // Hide mint button and show success
                    mintButtonContainer.classList.remove('show');
                    successText.textContent = `NFT #${tokenId} Minted Successfully!`;
                    openSeaLink.href = `https://opensea.io/assets/base/${NFT_CONTRACT_ADDRESS}/${tokenId}`;
                    successMessage.classList.add('show');
                    
                } catch (error) {
                    console.error('[Dave Contract] Mint error:', error);
                    mintButton.disabled = false;
                    mintButton.innerHTML = 'MINT AS NFT (0.001439 ETH)';
                    
                    if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                        showError('Transaction cancelled');
                    } else if (error.message?.includes('Already minted')) {
                        showError('You have already minted your NFT');
                    } else if (error.message?.includes('Insufficient')) {
                        showError('Insufficient funds for minting');
                    } else {
                        showError('Minting failed. Please try again.');
                    }
                }
            }
            
            // Button handlers
            executeButton.addEventListener('click', async () => {
                if (!connected) {
                    await connectWallet();
                } else {
                    await signDeclaration();
                }
            });
            
            mintButton.addEventListener('click', mintNFT);
            
            // Enter key
            nameInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && connected && !nameInput.disabled) {
                    await signDeclaration();
                }
            });
            
            mobileNameInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && connected && !mobileNameInput.disabled) {
                    await signDeclaration();
                }
            });
            
            // Listen for account/network changes
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        connected = false;
                        executeButton.innerHTML = 'CONNECT WALLET';
                        executeButton.disabled = false;
                        walletStatus.classList.remove('connected');
                        clearMessages();
                        // Reset UI
                        nameInput.disabled = false;
                        mobileNameInput.disabled = false;
                        inputLine.classList.remove('disabled');
                        mobileInputLine.classList.remove('disabled');
                        contractContainer.classList.remove('collapsed');
                        nftPreview.classList.remove('show');
                        mintButtonContainer.classList.remove('show');
                        successMessage.classList.remove('show');
                    } else if (connected && accounts[0].toLowerCase() !== userAddress.toLowerCase()) {
                        // Account changed - reconnect
                        window.location.reload();
                    }
                });
                
                window.ethereum.on('chainChanged', (chainId) => {
                    if (connected && chainId !== BASE_CHAIN_ID) {
                        showError('Please switch back to Base network');
                        connected = false;
                        executeButton.innerHTML = 'CONNECT WALLET';
                        executeButton.disabled = false;
                    }
                });
            }
            
            // Auto-focus input (desktop only)
            if (!isMobile) {
                nameInput.focus();
            }
            
            // Log wallet detection for debugging
            console.log('[Dave Contract] Wallet detection:', walletInfo);
        });
    </script>
</body>
</html>
